<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>FedViz - Federal Contract Intelligence</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
<style>
:root {
  /* Colors */
  --primary: #007AFF;
  --primary-rgb: 0, 122, 255;
  --primary-dark: #0056b3;
  --primary-light: #58AFFF;
  --secondary: #8E8E93;
  --accent: #5AC8FA;
  --success: #34C759;
  --warning: #FF9500;
  --danger: #FF3B30;
  --text-primary: #1D1D1F;
  --text-secondary: #8A8A8E;
  --text-tertiary: #AEAEB2;
  --bg-primary: #FFFFFF;
  --bg-secondary: #F2F2F7;
  --bg-tertiary: #E5E5EA;
  --bg-dark: #787880;
  --border: #C6C6C8;
  --border-light: #D1D1D6;
  
  /* Shadows & Radiuses */
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.04), 0 2px 4px 0 rgba(0, 0, 0, 0.04);
  --shadow: 0 3px 5px 0 rgba(0, 0, 0, 0.05), 0 4px 8px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 6px 10px 0 rgba(0, 0, 0, 0.06), 0 4px 12px 0 rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px 0 rgba(0, 0, 0, 0.07), 0 5px 20px 0 rgba(0, 0, 0, 0.07);
  --shadow-xl: 0 12px 25px 0 rgba(0, 0, 0, 0.08), 0 8px 30px 0 rgba(0, 0, 0, 0.08);
  --radius: 0.4rem;
  --radius-lg: 0.75rem;
  
  /* Layout */
  --sidebar-width: 280px;
  --sidebar-collapsed-width: 72px;
  --header-height: 56px;
  --transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
}

[data-theme="dark"] {
  --primary: #0A84FF;
  --primary-rgb: 10, 132, 255;
  --primary-dark: #0060DF;
  --primary-light: #59AFFF;
  --text-primary: #FFFFFF;
  --text-secondary: #8E8E93;
  --text-tertiary: #636366;
  --bg-primary: #1C1C1E;
  --bg-secondary: #000000;
  --bg-tertiary: #2C2C2E;
  --bg-dark: #030712;
  --border: #38383A;
  --border-light: #2C2C2E;
}

/* Base Styles */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  -webkit-tap-highlight-color: rgba(0,0,0,0);
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--bg-secondary);
  color: var(--text-primary);
  line-height: 1.5;
  font-size: 1rem;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  background: var(--bg-tertiary);
}
::-webkit-scrollbar-thumb {
  background: var(--text-tertiary);
  border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
  background: var(--text-secondary);
}

/* Layout */
.app-container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  position: relative;
}

.main-wrapper {
  margin-left: 0;
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.main-content {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  background-color: var(--bg-secondary);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.625rem 1.25rem;
  min-height: 44px;
  border: 1px solid transparent;
  border-radius: var(--radius);
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: background-color var(--transition), border-color var(--transition), opacity var(--transition);
  width: auto;
  box-shadow: none;
  line-height: 1.4;
}

.btn:active {
  opacity: 0.7;
  transform: none;
}

.btn-primary {
  background-color: var(--primary);
  color: white;
}
.btn-primary:hover {
  background-color: var(--primary-dark);
  opacity: 0.9;
}

.btn-secondary {
  background-color: var(--bg-tertiary);
  color: var(--primary);
  border: 1px solid var(--border);
}
.btn-secondary:hover {
  background-color: var(--border-light);
  border-color: var(--text-tertiary);
  opacity: 0.9;
}

.btn.active {
  background-color: var(--primary);
  color: white;
  border-color: var(--primary);
  opacity: 1;
}

/* Sidebar */
.sidebar {
  width: 100%;
  height: auto;
  position: relative;
  background: var(--bg-primary);
  box-shadow: none;
  border-right: none;
  border-bottom: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  transition: transform var(--transition), width var(--transition);
  z-index: auto;
}

.sidebar .sidebar-header {
  padding: 0.75rem 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: auto;
  min-height: 48px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  padding-left: 1.25rem;
  padding-right: 1.25rem;
}

.sidebar .logo {
  font-size: 2rem;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  text-decoration: none;
  color: var(--text-primary);
}

.logo-group {
  display: flex;
  flex-direction: column;
  line-height: 1.1;
}

.logo-text {
  font-size: 2rem;
  font-weight: 800;
  color: var(--text-primary);
  display: block;
  transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
}

.logo-subtitle {
  display: block;
  font-size: 0.9rem;
  font-weight: 400;
  color: var(--text-secondary);
  letter-spacing: 0.025em;
  margin-top: 0.1em;
}

.sidebar.collapsed .logo-text,
.sidebar.collapsed .logo-subtitle,
.sidebar.collapsed .nav-section-title {
  opacity: 0;
  height: 0;
  overflow: hidden;
  transform: translateX(-10px);
  pointer-events: none;
}

.sidebar .sidebar-header .header-button {
  padding: 0.5rem;
  font-size: 1.125rem;
  background: none;
  border: none;
  color: var(--primary);
  cursor: pointer;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
}

.sidebar .sidebar-header .header-button:hover {
  background: var(--border-light);
}

[data-theme="dark"] .sidebar .sidebar-header .header-button:hover {
  background: var(--border);
}

.sidebar .sidebar-nav {
  padding: 0.75rem 1rem;
  overflow-y: auto;
  flex: initial;
}

.sidebar .nav-section {
  margin-bottom: 0.75rem;
}

.sidebar .nav-section-title {
  font-size: 0.8125rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
  padding: 0 0.75rem;
  opacity: 1;
  height: auto;
  overflow: visible;
}

.sidebar-backdrop {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  z-index: 190;
  opacity: 0;
  transition: opacity var(--transition);
}

.sidebar-backdrop.active {
  display: block;
  opacity: 1;
}

/* Sidebar Containers */
.sidebar .search-container,
.sidebar .upload-container,
.sidebar .target-selection-container {
  padding: 0.75rem;
  margin-bottom: 0.75rem;
  border-radius: var(--radius);
  background-color: var(--bg-primary);
  border: 1px solid var(--border-light);
}

[data-theme="dark"] .sidebar .search-container,
[data-theme="dark"] .sidebar .upload-container,
[data-theme="dark"] .sidebar .target-selection-container {
  background-color: var(--bg-tertiary);
  border-color: var(--border);
}

.sidebar .search-title,
.sidebar .upload-title {
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 0.625rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* Status Message */
.sidebar .status-message {
  padding: 0.625rem 0.875rem;
  font-size: 0.8125rem;
  margin-bottom: 0.75rem;
  border-radius: var(--radius);
  background-color: var(--bg-primary);
  border: 1px solid var(--border);
  color: var(--text-primary);
  display: flex;
  flex-direction: column;
}

[data-theme="dark"] .sidebar .status-message {
  background-color: var(--bg-primary);
  border-color: var(--border-light);
}

.sidebar .status-message .primary-message {
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 0.25rem;
  display: flex;
  align-items: center;
}

.sidebar .status-message .primary-message i {
  font-size: 0.875rem;
  margin-right: 0.375rem;
}

.sidebar .status-message.info .primary-message i { color: var(--secondary); }
.sidebar .status-message.success .primary-message i { color: var(--success); }
.sidebar .status-message.error .primary-message i { color: var(--danger); }

.sidebar .status-message .filter-tags {
  margin-top: 0.375rem;
  gap: 0.25rem;
  display: flex;
  flex-wrap: wrap;
}

.sidebar .status-message .filter-tag {
  padding: 0.125rem 0.375rem;
  font-size: 0.75rem;
  background-color: var(--bg-tertiary);
  border: none;
  border-radius: var(--radius);
  color: var(--text-primary);
  display: inline-flex;
  align-items: center;
}

[data-theme="dark"] .sidebar .status-message .filter-tag {
  background-color: var(--border);
  color: var(--text-tertiary);
}

.sidebar .status-message .filter-tag .tag-label { 
  font-weight: 400; 
  color: var(--text-primary); 
  margin-right: 0.25rem; 
}

.sidebar .status-message .filter-tag .tag-value { 
  font-weight: 500; 
  color: var(--text-primary); 
}

[data-theme="dark"] .sidebar .status-message .filter-tag .tag-value { 
  color: var(--text-primary); 
}

/* Form Elements */
.sidebar .form-group {
  margin-bottom: 0.625rem;
}

.sidebar .form-label {
  font-size: 0.75rem;
  margin-bottom: 0.25rem;
  font-weight: 400;
  color: var(--text-secondary);
  display: block;
}

.sidebar .form-control {
  font-size: 0.875rem;
  padding: 0.5rem 0.75rem;
  min-height: 36px;
  height: 36px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background-color: var(--bg-primary);
  color: var(--text-primary);
  width: 100%;
  margin-bottom: 0;
  line-height: 1.4;
  transition: border-color var(--transition), box-shadow var(--transition);
}

[data-theme="dark"] .sidebar .form-control {
  background-color: var(--bg-tertiary);
  border-color: var(--border);
}

.sidebar .form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 1px var(--primary);
}

/* Sidebar Buttons */
.sidebar .btn {
  font-size: 0.8125rem;
  padding: 0.5rem 0.875rem;
  min-height: 36px;
  height: 36px;
  width: 100%;
  line-height: 1.2;
}

.sidebar .filter-actions {
  margin-top: 0.625rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.sidebar .filter-group#dynamicFiltersContainer {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0.25rem;
  margin-bottom: 0.625rem;
  padding: 0;
  overflow: visible;
}

.sidebar .filter-group#dynamicFiltersContainer .form-group {
  margin-bottom: 0;
}

/* File Input */
.sidebar input[type="file"].form-control {
  padding: 0;
  height: 40px;
  min-height: 40px;
}

.sidebar input[type="file"]#csvFileInput.form-control::file-selector-button {
  background-color: var(--primary);
  color: white;
  font-weight: 500;
  text-transform: none;
  padding: 0 1rem;
  height: 100%;
  border: none;
  border-right: 1px solid var(--border);
  margin-right: 0.625rem;
  cursor: pointer;
  transition: background-color var(--transition);
}

[data-theme="dark"] .sidebar input[type="file"]#csvFileInput.form-control::file-selector-button {
  border-right-color: var(--text-tertiary);
}

.sidebar input[type="file"]#csvFileInput.form-control::file-selector-button:hover {
  background-color: var(--primary-dark);
}

/* Target Selection */
.sidebar .target-selection-container .search-header { 
  padding: 0.5rem 0; 
  background: transparent; 
  margin-bottom: 0.25rem; 
  cursor: pointer; 
}

.sidebar .target-selection-container .search-title { 
  font-size: 0.875rem; 
  font-weight: 500; 
}

.sidebar .target-tabs { 
  display: flex; 
  border-bottom: 1px solid var(--border); 
  margin-bottom: 0.25rem; 
}

.sidebar .target-tabs .tab-btn {
  flex: 1; 
  padding: 0.5rem 0.25rem; 
  background: none; 
  border: none;
  border-bottom: 2px solid transparent; 
  cursor: pointer;
  color: var(--text-secondary); 
  font-size: 0.75rem; 
  font-weight: 400;
  transition: color var(--transition), border-color var(--transition);
}

.sidebar .target-tabs .tab-btn:hover { 
  color: var(--primary); 
}

.sidebar .target-tabs .tab-btn.active { 
  color: var(--primary); 
  border-bottom-color: var(--primary); 
  font-weight: 500; 
}

.sidebar .tab-content .search-box input.form-control { 
  margin-bottom: 0.25rem; 
  height: 32px; 
  min-height: 32px; 
  font-size: 0.8125rem;
}

.sidebar .selection-list { 
  max-height: 120px; 
  overflow-y: auto; 
  border: 1px solid var(--border); 
  border-radius: var(--radius); 
  padding: 0.125rem 0; 
  font-size: 0.75rem; 
}

.sidebar .selection-item { 
  padding: 0.375rem 0.5rem; 
  border-bottom: 1px solid var(--border-light); 
  display: flex; 
  align-items: center; 
  cursor: pointer; 
  transition: background-color var(--transition); 
}

.sidebar .selection-item:last-child { 
  border-bottom: none; 
}

.sidebar .selection-item:hover { 
  background-color: var(--bg-tertiary); 
}

.sidebar .selection-item input[type="checkbox"] { 
  margin-right: 0.375rem; 
  cursor: pointer; 
  accent-color: var(--primary); 
  width: 14px; 
  height: 14px; 
}

.sidebar .selection-item span { 
  overflow: hidden; 
  text-overflow: ellipsis; 
  white-space: nowrap; 
  font-size: 0.8125rem; 
}

.sidebar #targetFilterBtn, .sidebar #clearTargetsBtn { 
  flex: 1; 
  font-size: 0.8125rem; 
  padding: 0.5rem; 
  min-height: 32px; 
  height: 32px; 
}

/* Cards & Grids */
.dashboard-grid, .stats-grid {
  display: grid;
  gap: 1rem;
  margin-bottom: 1rem;
}

.card, .stat-card {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  padding: 1rem;
  box-shadow: var(--shadow-sm);
  border: none;
  transition: box-shadow var(--transition), transform var(--transition);
  position: relative;
  overflow: hidden;
}

.card:hover, .stat-card:hover {
  box-shadow: var(--shadow);
}

.card-header {
  display: flex; 
  align-items: center; 
  justify-content: space-between;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border-light);
}

.card-title {
  font-size: 1.0625rem;
  font-weight: 500;
  color: var(--text-primary);
  display: flex; 
  align-items: center; 
  gap: 0.5rem;
}

.stat-header {
  display: flex;
  justify-content: flex-start;
  margin-bottom: 0.25rem;
}

.stat-info {
  flex: 1;
}

.stat-label {
  font-size: 0.875rem;
  font-weight: 400;
  color: var(--text-secondary);
  margin-bottom: 0.125rem;
  text-transform: none;
  line-height: 1.4;
}

.stat-value {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.15;
  display: block;
}

.chart-container { 
  position: relative; 
  height: 280px; 
  margin-top: 1rem; 
}

/* Tables */
.table-container {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
  overflow: hidden;
  margin-bottom: 1.5rem;
}

.table-header {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--border);
  background-color: var(--bg-tertiary);
}

[data-theme="dark"] .table-header { 
  background-color: var(--bg-tertiary); 
}

.table-title { 
  font-size: 1rem; 
  font-weight: 500; 
  color: var(--text-primary); 
}

.table-wrapper { 
  overflow-x: auto; 
  -webkit-overflow-scrolling: touch;
}

table { 
  width: 100%; 
  border-collapse: collapse; 
}

th {
  background: var(--bg-tertiary);
  padding: 0.75rem 1rem;
  text-align: left;
  font-size: 0.8125rem;
  font-weight: 500;
  text-transform: none;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border);
  position: sticky; 
  top: 0; 
  z-index: 10;
}

[data-theme="dark"] th { 
  background: var(--bg-tertiary); 
}

td {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--border-light);
  font-size: 0.9375rem;
  color: var(--text-primary);
  vertical-align: middle;
}

tr:last-child td { 
  border-bottom: none; 
}

tr:hover td { 
  background: var(--bg-tertiary); 
}

[data-theme="dark"] tr:hover td { 
  background: var(--border); 
}

/* Column Widths for Tables */
#officeTable th:nth-child(1), #officeTable td:nth-child(1) { min-width: 100px; width: 15%; }
#officeTable th:nth-child(2), #officeTable td:nth-child(2) { min-width: 140px; width: 20%; }
#officeTable th:nth-child(3), #officeTable td:nth-child(3) { min-width: 90px; width: 10%; }
#officeTable th:nth-child(4), #officeTable td:nth-child(4) { min-width: 80px; width: 8%; }
#officeTable th:nth-child(5), #officeTable td:nth-child(5) { min-width: 180px; width: 25%; }
#officeTable th:nth-child(6), #officeTable td:nth-child(6) { min-width: 90px; width: 10%; }
#officeTable th:nth-child(7), #officeTable td:nth-child(7) { min-width: 80px; width: 12%; text-align: center; }

#targetTable th:nth-child(1), #targetTable td:nth-child(1) { min-width: 120px; width: 15%; }
#targetTable th:nth-child(2), #targetTable td:nth-child(2) { min-width: 90px; width: 9%; }
#targetTable th:nth-child(3), #targetTable td:nth-child(3) { min-width: 80px; width: 8%; }
#targetTable th:nth-child(4), #targetTable td:nth-child(4) { min-width: 70px; width: 7%; }
#targetTable th:nth-child(5), #targetTable td:nth-child(5) { min-width: 90px; width: 9%; }
#targetTable th:nth-child(6), #targetTable td:nth-child(6) { min-width: 180px; width: 25%; }
#targetTable th:nth-child(7), #targetTable td:nth-child(7) { min-width: 90px; width: 9%; }
#targetTable th:nth-child(8), #targetTable td:nth-child(8) { min-width: 80px; width: 10%; text-align: center; }

#contractsTable th:nth-child(1), #contractsTable td:nth-child(1) { min-width: 120px; width: 120px; white-space: nowrap; }
#contractsTable th:last-child, #contractsTable td:last-child { min-width: 140px; width: 140px; white-space: nowrap; text-align: center; }

/* Table Sorting */
th .sort-icon:after { 
  font-family: "Font Awesome 5 Free"; 
  font-weight: 900; 
  margin-left: 0.4em; 
  opacity: 0.4; 
  color: var(--text-tertiary); 
}

th.sort-asc .sort-icon:after { 
  content: "\f0de"; 
  opacity: 1; 
  color: var(--primary); 
}

th.sort-desc .sort-icon:after { 
  content: "\f0dd"; 
  opacity: 1; 
  color: var(--primary); 
}

/* Status Indicators */
#targetStatusIndicator {
  padding: 0.75rem 1rem; 
  border-radius: var(--radius);
  background-color: var(--bg-tertiary);
  border: 1px solid var(--border);
  margin-bottom: 1rem; 
  font-size: 0.875rem;
  color: var(--text-secondary);
  display: none; 
  align-items: center; 
  gap: 0.5rem;
}

#targetStatusIndicator i { 
  color: var(--secondary); 
  margin-right: 0.375rem; 
}

[data-theme="dark"] #targetStatusIndicator {
  background-color: var(--bg-tertiary);
  border-color: var(--border);
  color: var(--text-tertiary);
}

[data-theme="dark"] #targetStatusIndicator i { 
  color: var(--text-tertiary); 
}

/* Badges */
.badge {
  display: inline-block;
  padding: 0.25rem 0.625rem;
  border-radius: var(--radius);
  font-size: 0.75rem;
  font-weight: 500;
  line-height: 1.2;
}

.badge-inactive { 
  background-color: var(--border-light); 
  color: var(--text-tertiary); 
}

[data-theme="dark"] .badge-inactive { 
  background-color: var(--border); 
  color: var(--text-tertiary); 
}

.target-vendor td { 
  background-color: rgba(var(--primary-rgb), 0.05) !important; 
}

[data-theme="dark"] .target-vendor td { 
  background-color: rgba(var(--primary-rgb), 0.1) !important; 
}

/* Sankey Chart */
#sankeyChart { 
  width: 100%; 
  height: 450px; 
  position: relative; 
  overflow: hidden; 
  transition: height 0.3s ease; 
}

.node rect { 
  cursor: default; 
  fill-opacity: 0.95; 
  shape-rendering: crispEdges; 
  stroke-width: 0.5px; 
  stroke: var(--bg-primary); 
}

[data-theme="dark"] .node rect { 
  stroke: var(--bg-secondary); 
}

.node text { 
  pointer-events: none; 
  font-size: 11px; 
  font-weight: 400; 
  fill: var(--text-primary); 
  text-shadow: none !important; 
}

[data-theme="dark"] .node text { 
  fill: var(--text-primary) !important; 
}

.link { 
  fill: none; 
  stroke-opacity: 0.25; 
}

.link:hover { 
  stroke-opacity: 0.5; 
}

.node[data-depth="2"]:hover rect {
  stroke-width: 2px;
  stroke: #ffffff;
  filter: brightness(1.1);
}

#sankeyChart path.link:hover {
  stroke-opacity: 0.6 !important;
}

/* Sankey Controls */
#sankeyTop10, #sankeyTop25, #sankeyAll {
  padding: 0.5rem 0.875rem; 
  font-size: 0.875rem; 
  margin: 0 2px;
  background-color: var(--bg-tertiary); 
  color: var(--text-primary);
  border: 1px solid var(--border);
  text-transform: none;
  box-shadow: none;
  font-weight: 400;
}

#sankeyTop10:hover, #sankeyTop25:hover, #sankeyAll:hover { 
  background-color: var(--border); 
}

#sankeyTop10.active, #sankeyTop25.active, #sankeyAll.active {
  background-color: var(--primary); 
  color: white; 
  border-color: var(--primary); 
  opacity: 1;
}
/* FPDS Link */
.fpds-link {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  white-space: nowrap;
  text-decoration: none;
  padding: 0.4rem 0.75rem;
  background-color: var(--primary);
  color: white !important;
  border-radius: var(--radius);
  font-size: 0.75rem;
  font-weight: 500;
  transition: background-color 0.2s, opacity 0.2s;
  text-transform: none;
  box-shadow: none;
}

.fpds-link:hover {
  background-color: var(--primary-dark);
  opacity: 0.9;
}

.fpds-link i {
  margin-right: 3px;
  font-size: 0.75rem;
}

.example-fpds-link {
  color: var(--primary);
  text-decoration: none;
  display: inline-block;
  padding: 0.25rem 0;
}

.example-fpds-link:hover {
  text-decoration: underline;
  color: var(--primary-dark);
}

.example-links-container p {
  line-height: 1.4;
}

/* Chart Dark Mode Adjustments */
[data-theme="dark"] .chart-container,
[data-theme="dark"] .chart-container canvas,
[data-theme="dark"] .chartjs-legend li span,
[data-theme="dark"] .chartjs-tooltip,
[data-theme="dark"] .chartjs-tooltip-header {
  color: var(--text-primary) !important;
}

[data-theme="dark"] canvas {
  filter: brightness(1) contrast(1);
}

[data-theme="dark"] .chartjs-tooltip {
  background-color: rgba(50, 50, 52, 0.9) !important;
  border-color: rgba(80, 80, 82, 0.8) !important;
  box-shadow: var(--shadow-md);
}

/* Date Filters */
#dateSignedFilterGroup {
  margin-bottom: 0.75rem;
}

#dateSignedFilterGroup .form-control {
  font-size: 0.8125rem;
  padding: 0.5rem 0.75rem;
  min-height: 36px;
  height: 36px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  width: 100%;
  margin-bottom: 0;
  line-height: 1.4;
  transition: border-color var(--transition), box-shadow var(--transition);
}

#dateSignedFilterGroup .form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 1px var(--primary);
}

.date-filter-header {
  font-size: 0.75rem;
  margin-bottom: 0.25rem;
  font-weight: 500;
  color: var(--text-primary);
  display: block;
}

/* Main Status Container */
.main-status-container {
  margin-bottom: 1.5rem;
  width: 100%;
}

.main-status-wrapper {
  background-color: var(--bg-primary);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  padding: 1.25rem 1.5rem;
  transition: all 0.3s ease;
  color: var(--text-primary);
}

.main-status-message {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.status-heading {
  font-size: 2rem;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
  line-height: 1.4;
}

.status-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.75rem;
}

.status-filter-tag {
  display: flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.375rem 0.75rem;
  background-color: var(--bg-tertiary);
  border-radius: var(--radius);
  font-size: 0.875rem;
  color: var(--text-primary);
}

.status-filter-label {
  font-weight: 500;
  color: var(--text-primary);
}

.status-filter-value {
  font-weight: 600;
  color: var(--text-primary);
}

.status-filter-tag i {
  color: var(--text-primary);
  font-size: 0.75rem;
}

/* Data Context Info */
.data-context-info {
  margin-top: 0.75rem;
  margin-bottom: 1rem;
  padding: 0.875rem 1.25rem;
  background-color: rgba(var(--primary-rgb), 0.1);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
  position: relative;
}

.info-icon {
  color: var(--primary);
  font-size: 1.125rem;
  flex-shrink: 0;
}

.info-text {
  flex: 1;
  line-height: 1.5;
}

#contextMonth, 
#contextDate {
  font-weight: 600;
  color: var(--text-primary);
}

/* Month Progress */
.month-progress-container {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.375rem;
  min-width: 100px;
  margin-left: auto;
}

.month-progress-bar {
  width: 100%;
  height: 8px;
  background-color: var(--bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
}

.month-progress-fill {
  height: 100%;
  background-color: var(--primary);
  border-radius: 4px;
  width: 0%;
  transition: width 0.5s ease-in-out;
}

.month-progress-text {
  font-weight: 600;
  font-size: 0.875rem;
  color: var(--primary);
  text-align: right;
}

/* Archive Months */
.archive-months-container {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-top: 0.75rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.archive-months-title {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
}

.archive-months-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.archive-month-btn {
  padding: 0.5rem 0.875rem;
  font-size: 0.8125rem;
  background-color: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s ease;
}

.archive-month-btn:hover {
  background-color: var(--border-light);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

.archive-month-btn.active {
  background-color: var(--primary);
  color: white;
  border-color: var(--primary);
}

/* Search Input Styling */
#unifiedSearch {
  background-color: rgba(var(--primary-rgb), 0.05);
  border-color: var(--border);
  transition: background-color 0.2s ease, border-color 0.2s ease;
}

#unifiedSearch:not([value=""]) {
  border-color: var(--primary);
  background-color: rgba(var(--primary-rgb), 0.1);
}

#unifiedSearch:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 1px var(--primary);
  background-color: rgba(var(--primary-rgb), 0.1);
}

[data-theme="dark"] #unifiedSearch {
  background-color: rgba(var(--primary-rgb), 0.08);
  border-color: var(--border);
}

[data-theme="dark"] #unifiedSearch:not([value=""]) {
  border-color: var(--primary);
  background-color: rgba(var(--primary-rgb), 0.15);
}

[data-theme="dark"] #unifiedSearch:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 1px var(--primary);
  background-color: rgba(var(--primary-rgb), 0.15);
}

/* Loading Overlay */
#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.3s ease;
}

.loading-spinner {
  background-color: var(--bg-primary);
  padding: 2rem;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  max-width: 80%;
  text-align: center;
}

.loading-spinner i {
  font-size: 2.5rem;
  color: var(--primary);
  animation: spin 1.5s linear infinite;
}

.loading-spinner .loading-message {
  font-size: 1.125rem;
  font-weight: 500;
  color: var(--text-primary);
  margin-top: 0.5rem;
}

.loading-spinner .loading-details {
  font-size: 0.875rem;
  color: var(--text-secondary);
  margin-top: 0.25rem;
}

[data-theme="dark"] .loading-spinner {
  background-color: var(--bg-dark);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-progress {
  width: 100%;
  height: 4px;
  background-color: var(--bg-tertiary);
  border-radius: 2px;
  margin-top: 0.5rem;
  overflow: hidden;
}

.loading-progress-bar {
  height: 100%;
  background-color: var(--primary);
  border-radius: 2px;
  width: 0%;
  transition: width 0.3s ease;
}

@keyframes loading-progress {
  0% { width: 0%; opacity: 0.1; }
  50% { width: 100%; opacity: 0.8; }
  100% { width: 0%; opacity: 0.1; }
}

/* Mobile Styles */
.mobile-header {
  display: none;
}

.mobile-bottom-bar,
.mobile-search-bar,
.mobile-filter-modal,
.mobile-archives-modal,
.mobile-footer {
  display: none;
}

@media (max-width: 767px) {
  /* Layout */
  .main-content {
    padding: 0.75rem;
    padding-top: 0;
    padding-bottom: 70px;
  }
  
  .dashboard-grid, .stats-grid {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  
  .dashboard-grid > * {
    grid-column: 1 / -1 !important;
    grid-row: auto !important;
    height: auto !important;
    min-height: 300px;
  }
  
  .stat-value {
    font-size: 1.5rem;
  }
  
  .card, .stat-card {
    padding: 0.75rem;
  }
  
  .card-header {
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
  }
  
  th, td {
    padding: 0.625rem 0.75rem;
    font-size: 0.875rem;
  }
  
  .btn {
    padding: 0.625rem 1rem;
    font-size: 0.9375rem;
    min-height: 40px;
  }
  
  /* Chart sizes */
  .chart-container {
    height: 250px !important;
  }
  
  /* Hide sidebar */
  .sidebar {
    display: none;
  }
  
  /* Main wrapper takes full width */
  .main-wrapper {
    margin-left: 0;
    width: 100%;
  }
  
  /* Sankey adjustments */
  #sankeyContainer {
    min-height: 400px !important;
    height: auto !important;
  }
  
  #sankeyChart {
    height: 320px !important;
  }
  
  /* Touch targets */
  .btn, 
  .form-control,
  .selection-item,
  .archive-month-btn {
    min-height: 44px;
    padding: 0.75rem 1rem;
  }
  
  .form-group,
  .filter-actions {
    margin-bottom: 0.75rem;
  }
  
  td, th {
    padding: 0.75rem;
  }
  
  /* Hide upload container */
  .upload-container {
    display: none !important;
  }
  
  /* Date filter group */
  #dateSignedFilterGroup > div {
    flex-direction: column;
    gap: 0.375rem;
  }
  
  /* Main status container */
  .main-status-wrapper {
    padding: 1rem;
  }
  
  .status-heading {
    font-size: 1.25rem;
  }
  
  .data-context-info {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
  }
  
  .month-progress-container {
    width: 100%;
    margin-top: 0.5rem;
    align-items: flex-start;
  }
  
  .archive-months-container {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  /* Mobile Header */
  .mobile-header {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0.75rem 1rem;
    background-color: var(--bg-primary);
    border-bottom: 1px solid var(--border-light);
    margin-bottom: 1rem;
    box-shadow: var(--shadow-sm);
    text-align: center;
  }
  
  .mobile-header .logo-group {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .mobile-header .logo-text {
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--text-primary);
    line-height: 1.2;
  }
  
  .mobile-header .logo-subtitle {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 0.1rem;
  }
  
  /* Mobile Bottom Bar */
  .mobile-bottom-bar {
    display: flex;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: var(--bg-primary);
    border-top: 1px solid var(--border);
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    height: 60px;
    padding: 0 10px;
  }
  
  .mobile-bottom-bar .nav-button {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    background: none;
    border: none;
    padding: 8px 4px;
    cursor: pointer;
  }
  
  .mobile-bottom-bar .nav-button i {
    font-size: 1.25rem;
    margin-bottom: 4px;
  }
  
  .mobile-bottom-bar .nav-button span {
    font-size: 0.7rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }
  
  .mobile-bottom-bar .nav-button.active {
    color: var(--primary);
  }
  
  /* Mobile Search Bar */
  .mobile-search-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background-color: var(--bg-primary);
    padding: 0.75rem 1rem;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    z-index: 998;
    display: none;
    transform: translateY(-100%);
    transition: transform 0.3s ease-in-out;
  }
  
  .mobile-search-bar.active {
    transform: translateY(0);
    display: block;
  }
  
  .mobile-search-bar .search-input-container {
    position: relative;
    width: 100%;
  }
  
  .mobile-search-bar .search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
  }
  
  .mobile-search-bar input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    padding-right: 100px;
  }
  
  .mobile-search-bar .close-search {
    position: absolute;
    right: 56px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
  }
  
  .search-submit-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background-color: var(--primary);
    color: white;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 5;
  }
  
  /* Mobile Modals */
  .mobile-filter-modal,
  .mobile-archives-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 60px;
    background-color: var(--bg-primary);
    z-index: 999;
    overflow-y: auto;
    padding: 1rem;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease-in-out;
    transform: translateY(100%);
    display: none;
  }
  
  .mobile-filter-modal.active,
  .mobile-archives-modal.active {
    transform: translateY(0);
    display: block;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 0.75rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }
  
  .modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
  }
  
  .close-button {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary);
    cursor: pointer;
  }
  
  /* Filter Modal */
  .filter-section {
    margin-bottom: 1.5rem;
  }
  
  .filter-section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
    padding-bottom: 0.25rem;
    border-bottom: 1px solid var(--border-light);
  }
  
  .filter-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
  }
  
  .filter-buttons .btn {
    flex: 1;
    padding: 0.875rem;
    font-size: 1rem;
    height: 48px;
  }
  
  /* Archives Modal */
  .archives-title {
    margin-bottom: 1.5rem;
  }
  
  .archives-title h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }
  
  .archives-title p {
    font-size: 0.875rem;
    color: var(--text-secondary);
  }
  
  .archives-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  
  .mobile-archives-modal .archive-month-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    height: 100px;
    text-align: center;
  }
  
  .mobile-archives-modal .archive-month-btn i {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--primary);
  }
  
  .mobile-archives-modal .archive-month-btn span {
    font-size: 0.875rem;
  }
  
  .mobile-archives-modal .archive-month-btn.active i {
    color: white;
  }
  
  .no-archives {
    grid-column: 1 / -1;
    text-align: center;
    padding: 1rem;
    color: var(--text-secondary);
    font-style: italic;
  }
  
  /* Mobile content ordering */
  .main-content {
    display: flex;
    flex-direction: column;
  }
  
  .main-status-container { order: 1; }
  .stats-grid { order: 2; }
  .dashboard-grid { order: 3; }
  #officeTableContainer { order: 4; }
  #contractsTableContainer { order: 5; }
}

@media (min-width: 1024px) {
  .app-container {
    flex-direction: row;
  }
  
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: var(--sidebar-width);
    height: 100vh;
    box-shadow: var(--shadow-md);
    border-right: 1px solid var(--border);
    border-bottom: none;
    z-index: 200;
    transform: translateX(0);
  }
  
  [data-theme="dark"] .sidebar {
    border-right-color: var(--border);
    border-bottom-color: transparent;
  }
  
  .sidebar.collapsed {
    transform: translateX(0);
    width: var(--sidebar-collapsed-width);
  }
  
  .sidebar.collapsed .sidebar-header {
    padding: 1.5rem 0;
    justify-content: center;
  }
  
  .main-wrapper {
    margin-left: var(--sidebar-width);
  }
  
  .sidebar.collapsed + .main-wrapper {
    margin-left: var(--sidebar-collapsed-width);
  }
  
  .dashboard-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 1200px) {
  #officeTable th:nth-child(5), #officeTable td:nth-child(5), 
  #targetTable th:nth-child(6), #targetTable td:nth-child(6) {
    min-width: 150px;
  }
}
/* Add gap between file input and upload button */
#uploadForm {
  display: flex;
  flex-direction: column;
  gap: 10px; /* This creates the gap between elements */
}

/* If you want to specifically target just the gap between the file input and button */
#csvFileInput {
  margin-bottom: 10px; /* Alternative approach using margin */
}

/* Make sure the file input and button are properly styled */
#csvFileInput.form-control {
  width: 100%;
}

#loadBtn.btn.btn-primary {
  width: 100%;
}
/* Enhanced theme toggle icon styles */
.sidebar .header-button#themeToggle {
  padding: 8px;
  height: 36px;
  width: 36px;
  border-radius: 50%;
  background-color: rgba(var(--primary-rgb), 0.1);
  color: var(--text-primary); /* Match logo-title color */
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  border: 1px solid transparent;
}

.sidebar .header-button#themeToggle:hover {
  background-color: rgba(var(--primary-rgb), 0.15);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

.sidebar .header-button#themeToggle:active {
  transform: translateY(0);
}

.sidebar .header-button#themeToggle i {
  font-size: 16px;
  transition: transform 0.3s ease, color 0.3s ease;
}

/* Subtle animation when switching themes */
.sidebar .header-button#themeToggle i.fa-sun {
  color: #f6ad55; /* A warm sun color */
  transform: rotate(0deg);
}

.sidebar .header-button#themeToggle i.fa-moon {
  color: var(--text-primary); /* Match logo color */
  transform: rotate(-20deg);
}

/* Mobile header theme toggle styles */
#mobileThemeToggle {
  padding: 8px;
  height: 36px;
  width: 36px;
  border-radius: 50%;
  background-color: rgba(var(--primary-rgb), 0.1);
  color: var(--text-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  border: 1px solid transparent;
}

#mobileThemeToggle:hover {
  background-color: rgba(var(--primary-rgb), 0.15);
}

#mobileThemeToggle i {
  font-size: 16px;
  transition: transform 0.3s ease, color 0.3s ease;
}

#mobileThemeToggle i.fa-sun {
  color: #ffffff;
  transform: rotate(0deg);
}

#mobileThemeToggle i.fa-moon {
  color: var(--text-primary);
  transform: rotate(-20deg);
}

/* Dark mode specific adjustments */
[data-theme="dark"] .sidebar .header-button#themeToggle,
[data-theme="dark"] #mobileThemeToggle {
  background-color: rgba(var(--primary-rgb), 0.2);
}

[data-theme="dark"] .sidebar .header-button#themeToggle:hover,
[data-theme="dark"] #mobileThemeToggle:hover {
  background-color: rgba(var(--primary-rgb), 0.25);
}

[data-theme="dark"] .sidebar .header-button#themeToggle i.fa-sun {
  color: #ffffff;
}

[data-theme="dark"] .sidebar .header-button#themeToggle i.fa-moon,
[data-theme="dark"] #mobileThemeToggle i.fa-moon {
  color: #a3bffa; /* Light bluish color for moon in dark mode */
}
/* Loading Overlay - Make it work on all screen sizes */
#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.3s ease;
}

.loading-spinner {
  background-color: var(--bg-primary);
  padding: 2rem;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  max-width: 80%;
  width: 400px; /* Set a fixed width for desktop */
  text-align: center;
}

.loading-spinner i {
  font-size: 2.5rem;
  color: var(--primary);
  animation: spin 1.5s linear infinite;
}

.loading-spinner .loading-message {
  font-size: 1.125rem;
  font-weight: 500;
  color: var(--text-primary);
  margin-top: 0.5rem;
}

.loading-spinner .loading-details {
  font-size: 0.875rem;
  color: var(--text-secondary);
  margin-top: 0.25rem;
}

[data-theme="dark"] .loading-spinner {
  background-color: var(--bg-dark);
}

/* Animation for the spinner */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Loading Progress Bar */
.loading-progress {
  width: 100%;
  height: 4px;
  background-color: var(--bg-tertiary);
  border-radius: 2px;
  margin-top: 0.5rem;
  overflow: hidden;
}

.loading-progress-bar {
  height: 100%;
  background-color: var(--primary);
  border-radius: 2px;
  width: 0%;
  transition: width 0.3s ease;
}

@keyframes loading-progress {
  0% { width: 0%; opacity: 0.1; }
  50% { width: 100%; opacity: 0.8; }
  100% { width: 0%; opacity: 0.1; }
}

/* Make sure desktop is not hiding these elements */
@media (min-width: 768px) {
  #loadingOverlay,
  .loading-spinner,
  .loading-progress {
    display: flex; /* Ensure they're visible on desktop */
  }
  
  /* Position the loading overlay relative to the main content area on desktop */
  .main-wrapper #loadingOverlay {
    left: var(--sidebar-width); /* Adjust based on your sidebar width */
  }
  
  /* When sidebar is collapsed */
  .sidebar.collapsed + .main-wrapper #loadingOverlay {
    left: var(--sidebar-collapsed-width);
  }
}
/* Status Messages - Consistent across devices */
.main-status-container {
  margin-bottom: 1.5rem;
  width: 100%;
}

.main-status-wrapper {
  background-color: var(--bg-primary);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  padding: 1.25rem 1.5rem;
  transition: all 0.3s ease;
  color: var(--text-primary);
}

.main-status-message {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.status-heading {
  font-size: 1.5rem; /* Slightly smaller than mobile for consistency */
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
  line-height: 1.4;
}

.status-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.75rem;
}

.status-filter-tag {
  display: flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.375rem 0.75rem;
  background-color: var(--bg-tertiary);
  border-radius: var(--radius);
  font-size: 0.875rem;
  color: var(--text-primary);
}

@media (min-width: 768px) {
  /* Ensure desktop status message looks consistent with mobile */
  .status-heading {
    font-size: 1.5rem; /* Match mobile size */
  }
  
  .main-status-wrapper {
    box-shadow: var(--shadow-sm); /* Ensure shadow is visible on desktop */
  }
}
</style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo-group">
          <a href="#" class="logo">
            <span class="logo-text"><i class="fa-solid fa-flag-usa"></i> FedWon</span>
          </a>
          <span class="logo-subtitle">Federal Awards Viewer</span>
        </div>
        <button class="header-button" id="themeToggle" aria-label="Toggle Theme">
          <i class="fas fa-moon" aria-hidden="true"></i>
        </button>
      </div>

      <div class="sidebar-nav">
        <div class="nav-section">
          <!-- Search Container -->
          <div class="search-container">
            <div class="filter-container">
              <div class="form-group">
                <input type="text" id="unifiedSearch" placeholder="Search across all contract fields..." class="form-control">
              </div>
              <div class="filter-group" id="dynamicFiltersContainer"></div>
              <div class="filter-actions">
                <button class="btn btn-secondary" id="resetFiltersBtn">Reset Filters</button>
              </div>
            </div>
          </div>
          
          <!-- Upload Container -->
          <div class="upload-container">
            <div class="upload-title">Upload FPDS CSV Data</div>
            <form id="uploadForm">
              <label class="form-label" for="csvFileInput">Select CSV file</label>
              <input type="file" id="csvFileInput" accept=".csv" class="form-control">
              <button type="button" id="loadBtn" class="btn btn-primary">Load Data</button>
            </form>
          </div>
          
          <!-- Data Context Info -->
          <div id="dataContextInfo" class="data-context-info">
            <div class="info-icon"><i class="fas fa-info-circle"></i></div>
            <div class="info-text">
              Showing contract awards >$100K for <span id="contextMonth">the current month</span> through <span id="contextDate">today</span>.
            </div>
          </div>

          <!-- Archive Months Container -->
          <div id="archiveMonthsContainer" class="archive-months-container">
            <div class="archive-months-title">Archives:</div>
            <div id="archiveMonthsList" class="archive-months-list">
              <!-- Archive month buttons will be added here dynamically -->
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-wrapper">
      <main class="main-content">
        <!-- Status Container -->
        <div id="mainStatusContainer" class="main-status-container">
          <div class="main-status-wrapper">
            <div id="mainStatusMessage" class="main-status-message">
              <h2 class="status-heading" id="statusHeading">Viewing all Awards</h2>
            </div>
            <div id="statusFilters" class="status-filters"></div>
          </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <div class="stat-label">Total Contracts</div>
                <div class="stat-value" id="totalContracts">0</div>
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <div class="stat-label">Total Contract Value</div>
                <div class="stat-value" id="totalValue">$0</div>
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-info">
                <div class="stat-label">Total Vendors</div>
                <div class="stat-value" id="activeVendors">0</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Dashboard Grid (for charts) -->
        <div class="dashboard-grid"></div>

        <!-- Office Table -->
        <div class="table-container" id="officeTableContainer">
          <div class="table-header">
            <h3 class="table-title">Top Contracting Offices</h3>
          </div>
          <div class="table-wrapper">
            <table class="sortable" id="officeTable" aria-labelledby="officeTableContainer">
              <thead>
                <tr>
                  <th data-sort="string" scope="col">Agency <span class="sort-icon"></span></th>
                  <th data-sort="string" scope="col">Contracting Office <span class="sort-icon"></span></th>
                  <th data-sort="number" scope="col">Total Value <span class="sort-icon"></span></th>
                  <th data-sort="number" scope="col">Contracts <span class="sort-icon"></span></th>
                  <th data-sort="string" scope="col">Top Vendor <span class="sort-icon"></span></th>
                  <th data-sort="number" scope="col">Largest Contract <span class="sort-icon"></span></th>
                  <th data-sort="string" scope="col">View Details</th>
                </tr>
              </thead>
              <tbody id="officeTableBody">
                <!-- Table body will be populated dynamically -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Contracts Table -->
        <div class="table-container" id="contractsTableContainer">
          <div class="table-header">
            <h3 class="table-title">Recent Contract Awards</h3>
          </div>
          <div class="table-wrapper">
            <table class="sortable" id="contractsTable" aria-labelledby="contractsTableContainer">
              <thead>
                <tr>
                  <th data-sort="date" scope="col">Award Date <span class="sort-icon"></span></th>
                  <th data-sort="string" scope="col">Vendor <span class="sort-icon"></span></th>
                  <th data-sort="string" scope="col">Agency <span class="sort-icon"></span></th>
                  <th data-sort="string" scope="col">Description <span class="sort-icon"></span></th>
                  <th data-sort="number" scope="col">Value <span class="sort-icon"></span></th>
                  <th data-sort="string" scope="col">Status <span class="sort-icon"></span></th>
                </tr>
              </thead>
              <tbody id="contractsTableBody"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>
  
  <!-- Mobile UI Elements -->
  <!-- Mobile Bottom Navigation Bar -->
  <div class="mobile-bottom-bar" id="mobileBottomBar">
    <button class="nav-button active" data-target="main" id="dashboardBtn">
      <i class="fas fa-chart-bar"></i>
      <span>Dashboard</span>
    </button>
    <button class="nav-button" data-target="search" id="searchBtn">
      <i class="fas fa-search"></i>
      <span>Search</span>
    </button>
    <button class="nav-button" data-target="filter" id="filterBtn">
      <i class="fas fa-filter"></i>
      <span>Filters</span>
    </button>
    <button class="nav-button" data-target="archives" id="archivesBtn">
      <i class="fas fa-archive"></i>
      <span>Archives</span>
    </button>
    <button class="nav-button" data-target="reset" id="resetBtn">
      <i class="fas fa-undo"></i>
      <span>Reset</span>
    </button>
  </div>
  
  <!-- Mobile Search Bar -->
  <div class="mobile-search-bar" id="mobileSearchBar">
    <div class="search-input-container">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="mobileSearchInput" placeholder="Search across all contract fields...">
      <button class="close-search" id="closeSearchBtn">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <!-- Mobile Filter Modal -->
  <div class="mobile-filter-modal" id="mobileFilterModal">
    <div class="modal-header">
      <div class="modal-title">Filter Options</div>
      <button class="close-button" id="closeFilterBtn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-content" id="mobileFilterContent">
      <!-- This will be populated with filter controls -->
    </div>
  </div>
</body>
<script>
/**
 * Federal Contract Intelligence Visualization
 * Optimized production-ready JavaScript
 */

// Define a portable application namespace
const App = window.App || {};

// Core application data and state
App.data = {
  allData: [],
  filteredData: [],
  charts: {},
  currentSankeyLimit: 25, // Default to showing top 25 flows
  vendorColorMap: new Map(),
  currentDataPeriod: null,
  periodDescription: "",
  isAutoLoadedData: false,
  currentMonthActive: true,
  // Archive months configuration - update as needed
  archiveMonths: [
    { month: "Jan", year: "2025", url: "https://subhoodata.s3.us-east-1.amazonaws.com/data/jan25.csv" },
    { month: "Feb", year: "2025", url: "https://subhoodata.s3.us-east-1.amazonaws.com/data/feb25.csv" },
    { month: "Mar", year: "2025", url: "https://subhoodata.s3.us-east-1.amazonaws.com/data/march25.csv" },
    { month: "Apr", year: "2025", url: "https://subhoodata.s3.us-east-1.amazonaws.com/data/april2025.csv" }
  ]
};

// DOM elements cache to reduce repeated queries
App.elements = {};

// Event listeners registry for proper cleanup
App.eventListeners = [];

/**
 * Feature detection and browser support
 */
App.support = {
  localStorage: (function() {
    try {
      localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
      return true;
    } catch (e) {
      return false;
    }
  })(),
  
  fileReader: typeof FileReader !== 'undefined',
  fetch: typeof fetch !== 'undefined',
  
  // Device and viewport detection
  isMobile: function() {
    return window.innerWidth < 768;
  }
};

/**
 * Error handling and logging
 */
App.handleError = function(context, error, userMessage = null) {
  console.error(`Error in ${context}:`, error);
  if (userMessage && typeof App.ui.showMessage === 'function') {
    App.ui.showMessage(userMessage || `Error: ${error.message}`, "error");
  }
};

/**
 * Utility functions
 */
App.utils = {
  /**
   * Safely add event listener and register it for cleanup
   */
  addEventListenerSafe: function(element, eventType, handler) {
    if (!element) return null;
    
    element.addEventListener(eventType, handler);
    App.eventListeners.push({ element, eventType, handler });
    return handler;
  },
  
  /**
   * Remove all registered event listeners
   */
  cleanupEventListeners: function() {
    App.eventListeners.forEach(({ element, eventType, handler }) => {
      if (element) {
        element.removeEventListener(eventType, handler);
      }
    });
    App.eventListeners.length = 0;
  },
  
  /**
   * Call a function if it exists
   */
  callIfExists: function(functionName, ...args) {
    if (typeof window[functionName] === 'function') {
      return window[functionName](...args);
    }
    return null;
  },
  
  /**
   * Format currency values for display
   */
  formatCurrency: function(amount) {
    if (amount >= 1000000000) {
      return '$' + (amount / 1000000000).toFixed(1) + 'B';
    } else if (amount >= 1000000) {
      return '$' + (amount / 1000000).toFixed(1) + 'M';
    } else if (amount >= 1000) {
      return '$' + (amount / 1000).toFixed(1) + 'K';
    }
    return '$' + amount.toLocaleString();
  },
  
  /**
   * Format a date for display
   */
  formatDate: function(dateStr) {
    const date = App.utils.parseDate(dateStr);
    if (!date) return 'N/A';
    
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
  },
  
  /**
   * Parse date from various formats
   */
  parseDate: function(dateStr) {
    if (!dateStr) return null;
    
    // Handle format like "16-May-25"
    const dateMatch = dateStr.match(/(\d+)-(\w+)-(\d+)/);
    if (dateMatch) {
      const day = parseInt(dateMatch[1]);
      const month = dateMatch[2];
      const year = parseInt(dateMatch[3]);
      
      // Map month names to month indices
      const monthMap = {
        'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
        'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
      };
      
      // Get month index
      const monthIndex = monthMap[month];
      if (monthIndex === undefined) {
        return null;
      }
      
      // Convert 2-digit year to 4-digit
      const fullYear = year < 50 ? 2000 + year : 1900 + year;
      
      return new Date(fullYear, monthIndex, day);
    }
    
    // Handle format like "Jan 15, 2024"
    const dateParts = dateStr.match(/(\w+)\s+(\d+),\s+(\d+)/);
    if (dateParts) {
      const monthName = dateParts[1];
      const day = parseInt(dateParts[2]);
      const year = parseInt(dateParts[3]);
      
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                         'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const month = monthNames.indexOf(monthName.substr(0, 3));
      
      if (month !== -1) {
        return new Date(year, month, day);
      }
    }
    
    // Try standard date parsing
    const date = new Date(dateStr);
    return isNaN(date.getTime()) ? null : date;
  },
  
  /**
   * Get the last day of a month
   */
  getLastDayOfMonth: function(monthName, year) {
    const months = ["January", "February", "March", "April", "May", "June", 
                    "July", "August", "September", "October", "November", "December"];
    const monthIndex = months.findIndex(m => m.toLowerCase() === monthName.toLowerCase());
    
    if (monthIndex === -1) return new Date();
    
    // Get the last day of the month (day 0 of next month)
    return new Date(parseInt(year), monthIndex + 1, 0);
  },
  
  /**
   * Parse money values from various formats
   */
  parseMoneyValue: function(value) {
    if (!value) return 0;
    
    // Handle various formats
    const cleanValue = value.toString()
      .replace(/[$,\s"]/g, '') // Remove $, commas, spaces, quotes
      .replace(/\s+/g, '')     // Remove any remaining whitespace
      .trim();                  // Trim any leading/trailing spaces
      
    const result = parseFloat(cleanValue) || 0;
    return result;
  },
  
  /**
   * Parse a single CSV line
   */
  parseCSVLine: function(line) {
    if (!line) return [];
    
    const result = [];
    let current = "";
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      const next = line[i + 1] || '';
      
      if (char === '"') {
        if (inQuotes && next === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === ',' && !inQuotes) {
        result.push(current.trim());
        current = "";
      } else {
        current += char;
      }
    }
    
    result.push(current.trim());
    return result;
  },
  
  /**
   * Handle modal visibility
   */
  handleModal: function(modalId, action = 'toggle') {
    const modal = document.getElementById(modalId);
    if (!modal) return false;
    
    if (action === 'show') {
      modal.classList.add('active');
      return true;
    } else if (action === 'hide') {
      modal.classList.remove('active');
      return true;
    } else if (action === 'toggle') {
      modal.classList.toggle('active');
      return modal.classList.contains('active');
    }
    return false;
  },
  
  /**
   * Get vendor color consistently
   */
  getVendorColor: function(vendorName, index) {
    // Use existing color if already assigned
    if (App.data.vendorColorMap.has(vendorName)) {
      return App.data.vendorColorMap.get(vendorName);
    }
    
    // Default chart colors
    const chartColors = [
      '#667eea', '#764ba2', '#f093fb', '#f5576c', 
      '#4facfe', '#43e97b', '#a8eb12', '#ebbf12'
    ];
    
    // Assign a new color and store it
    const color = chartColors[index % chartColors.length];
    App.data.vendorColorMap.set(vendorName, color);
    return color;
  }
};

/**
 * UI management functions
 */
App.ui = {
  /**
   * Initialize DOM elements cache
   */
  cacheElements: function() {
    // Main elements
    App.elements = {
      sidebar: document.getElementById('sidebar'),
      mainWrapper: document.querySelector('.main-wrapper'),
      mainContent: document.querySelector('.main-content'),
      dashboardGrid: document.querySelector('.dashboard-grid'),
      statsGrid: document.querySelector('.stats-grid'),
      
      // Form elements
      unifiedSearch: document.getElementById('unifiedSearch'),
      csvFileInput: document.getElementById('csvFileInput'),
      loadBtn: document.getElementById('loadBtn'),
      resetFiltersBtn: document.getElementById('resetFiltersBtn'),
      dynamicFiltersContainer: document.getElementById('dynamicFiltersContainer'),
      
      // Status and info elements
      mainStatusContainer: document.getElementById('mainStatusContainer'),
      statusHeading: document.getElementById('statusHeading'),
      statusFilters: document.getElementById('statusFilters'),
      dataContextInfo: document.getElementById('dataContextInfo'),
      contextMonth: document.getElementById('contextMonth'),
      contextDate: document.getElementById('contextDate'),
      archiveMonthsContainer: document.getElementById('archiveMonthsContainer'),
      archiveMonthsList: document.getElementById('archiveMonthsList'),
      
      // Stat elements
      totalContracts: document.getElementById('totalContracts'),
      totalValue: document.getElementById('totalValue'),
      activeVendors: document.getElementById('activeVendors'),
      
      // Table elements
      officeTableBody: document.getElementById('officeTableBody'),
      contractsTableBody: document.getElementById('contractsTableBody'),
      
      // Mobile elements
      mobileBottomBar: document.getElementById('mobileBottomBar'),
      mobileSearchBar: document.getElementById('mobileSearchBar'),
      mobileSearchInput: document.getElementById('mobileSearchInput'),
      mobileFilterModal: document.getElementById('mobileFilterModal'),
      mobileFilterContent: document.getElementById('mobileFilterContent'),
      
      // Mobile buttons
      dashboardBtn: document.getElementById('dashboardBtn'),
      searchBtn: document.getElementById('searchBtn'),
      filterBtn: document.getElementById('filterBtn'),
      archivesBtn: document.getElementById('archivesBtn'),
      resetBtn: document.getElementById('resetBtn'),
      closeSearchBtn: document.getElementById('closeSearchBtn'),
      closeFilterBtn: document.getElementById('closeFilterBtn')
    };
  },
  
  /**
   * Show a message to the user
   */
  showMessage: function(primaryMessage, type, filters) {
    // Display message in main status area
    App.ui.showEnhancedMessage(primaryMessage, type, filters);
    
    // Also update sidebar status for backwards compatibility
    App.ui.updateSidebarStatusMessage(primaryMessage, type, filters);
  },
  
  /**
   * Show enhanced message in the main content area
   */
  showEnhancedMessage: function(primaryMessage, type, filters) {
    const statusHeading = App.elements.statusHeading;
    const statusFilters = App.elements.statusFilters;
    const mainStatusWrapper = document.querySelector('.main-status-wrapper');
    
    if (!statusHeading || !statusFilters || !mainStatusWrapper) {
      return;
    }
    
    // Create a natural language description based on the filters
    const naturalDescription = App.ui.generateNaturalDescription(filters);
    
    // Update the heading with the natural language description
    statusHeading.textContent = naturalDescription;
    
    // Add or remove has-filters class based on whether there are filters
    if (filters && Object.keys(filters).length > 0) {
      mainStatusWrapper.classList.add('has-filters');
    } else {
      mainStatusWrapper.classList.remove('has-filters');
    }
    
    // Clear previous filter tags
    statusFilters.innerHTML = '';
    
    // Add filter tags if provided
    if (filters && Object.keys(filters).length > 0) {
      // Add each filter as a tag
      for (const [key, value] of Object.entries(filters)) {
        if (value) {
          const tag = document.createElement('div');
          tag.className = 'status-filter-tag';
          tag.innerHTML = `
            <span class="status-filter-label">${key}:</span>
            <span class="status-filter-value">${value}</span>
          `;
          statusFilters.appendChild(tag);
        }
      }
    }
  },
  
  /**
   * Update the sidebar status message (for backward compatibility)
   */
  updateSidebarStatusMessage: function(primaryMessage, type, filters) {
    const sidebarStatusElement = document.getElementById('statusMessage');
    if (!sidebarStatusElement) return;
    
    // Determine icon based on message type
    let icon = 'fa-info-circle';
    if (type === 'success') icon = 'fa-check-circle';
    if (type === 'error') icon = 'fa-exclamation-circle';
    
    // Start with primary message
    let content = `<div class="primary-message"><i class="fas ${icon}"></i>${primaryMessage}</div>`;
    
    // Add filter tags if provided
    if (filters && Object.keys(filters).length > 0) {
      content += `<div class="filter-tags">`;
      
      // Add each filter as a tag
      for (const [key, value] of Object.entries(filters)) {
        if (value) {
          content += `<div class="filter-tag"><span class="tag-label">${key}:</span> <span class="tag-value">${value}</span></div>`;
        }
      }
      
      content += `</div>`;
    }
    
    sidebarStatusElement.innerHTML = content;
    
    // Remove all previous classes
    sidebarStatusElement.className = 'status-message';
    
    // Add appropriate class
    if (type) {
      sidebarStatusElement.className += ' ' + type;
    }
  },
  
  /**
   * Generate natural language description of filters
   */
  generateNaturalDescription: function(filters) {
    // Only include period text for auto-loaded data
    let periodText = "";
    if (App.data.isAutoLoadedData && App.data.periodDescription) {
      periodText = App.data.periodDescription;
    }
    
    if (!filters || Object.keys(filters).length === 0) {
      return `Viewing all Awards ${periodText}`;
    }
    
    // Extract key filter components
    const agency = filters["Agency"] || "";
    const vendor = filters["Vendor"] || "";
    const month = filters["Month"] || "";
    const year = filters["Year"] || "";
    const searchTerm = filters["Search"] || "";
    const naicsCode = filters["NAICS"] || "";
    const naicsDesc = filters["NAICS Description"] || "";
    
    // Start building the natural language description
    let description = "";
    
    // Build agency/vendor/date part of the description
    if (agency) {
      description += `${agency} awards `;
    } else {
      description += "Awards ";
    }
    
    if (vendor) {
      description += `to ${vendor} `;
    }
    
    // Use month/year from filters if specified, otherwise use the detected period
    if (month && year) {
      description += `from ${month} ${year} `;
    } else if (month) {
      description += `from ${month} `;
    } else if (year) {
      description += `from ${year} `;
    } else if (periodText && !filters["Month"] && !filters["Year"] && App.data.isAutoLoadedData) {
      // Only add the period text if no specific month/year filter is applied
      description += `${periodText} `;
    }
    
    // Add NAICS information
    if (naicsCode && naicsDesc) {
      description += `for ${naicsDesc} (NAICS ${naicsCode}) `;
    } else if (naicsCode) {
      description += `with NAICS code ${naicsCode} `;
    } else if (naicsDesc) {
      description += `for ${naicsDesc} `;
    }
    
    // Add search term
    if (searchTerm) {
      description += `containing "${searchTerm}" `;
    }
    
    // Clean up the description
    description = description.trim();
    if (!description.endsWith(".")) {
      description += ".";
    }
    
    return description;
  },
  
  /**
   * Toggle theme between light and dark mode
   */
  toggleTheme: function() {
    const theme = document.documentElement.getAttribute('data-theme') || 'light';
    const newTheme = theme === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', newTheme);
    
    // Save preference
    if (App.support.localStorage) {
      localStorage.setItem('theme', newTheme);
    }
    
    // Update theme icons
    App.ui.updateThemeIcons(newTheme);
    
    // Update chart colors
    if (typeof App.charts.updateColors === 'function') {
      App.charts.updateColors();
    }
    
    return newTheme;
  },
  
  /**
   * Update theme icons across the UI
   */
  updateThemeIcons: function(theme) {
    const themeToggles = [
      document.getElementById('themeToggle'),
      document.getElementById('mobileThemeToggle')
    ];
    
    themeToggles.forEach(toggle => {
      if (!toggle) return;
      const icon = toggle.querySelector('i');
      if (icon) {
        icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      }
    });
  },
  
  /**
   * Show loading indicator
   */
  showLoadingIndicator: function(isLoading, message = "Loading data...", details = "", progress = -1) {
    // Create loading overlay if it doesn't exist
    let loadingOverlay = document.getElementById('loadingOverlay');
    
    if (!loadingOverlay && isLoading) {
      loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'loadingOverlay';
      loadingOverlay.innerHTML = `
        <div class="loading-spinner">
          <i class="fas fa-circle-notch fa-spin"></i>
          <div class="loading-message" id="loadingMessage">${message}</div>
          <div class="loading-details" id="loadingDetails">${details}</div>
          <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
          </div>
        </div>
      `;
      document.body.appendChild(loadingOverlay);
    }
    
    // Show or hide the overlay
    if (loadingOverlay) {
      if (isLoading) {
        loadingOverlay.style.display = 'flex';
        
        // Update message and details if provided
        const msgEl = document.getElementById('loadingMessage');
        const detailsEl = document.getElementById('loadingDetails');
        const progressBar = document.getElementById('loadingProgressBar');
        
        if (msgEl) msgEl.textContent = message;
        
        if (detailsEl) {
          if (details) {
            detailsEl.textContent = details;
            detailsEl.style.display = 'block';
          } else {
            detailsEl.style.display = 'none';
          }
        }
        
        // Handle progress bar
        if (progressBar) {
          if (progress >= 0 && progress <= 100) {
            progressBar.style.width = `${progress}%`;
            progressBar.parentElement.style.display = 'block';
          } else {
            // Indeterminate progress or no progress specified
            progressBar.style.width = '100%';
            progressBar.style.animation = 'loading-progress 1.5s infinite ease-in-out';
            progressBar.parentElement.style.display = 'block';
          }
        }
      } else {
        // Add a fade-out effect before removing
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
          loadingOverlay.style.display = 'none';
          loadingOverlay.style.opacity = '1';
        }, 300);
      }
    }
  },
  
  /**
   * Update loading progress
   */
  updateLoadingProgress: function(progress, message = null, details = null) {
    const progressBar = document.getElementById('loadingProgressBar');
    const msgEl = document.getElementById('loadingMessage');
    const detailsEl = document.getElementById('loadingDetails');
    
    if (progressBar && progress >= 0 && progress <= 100) {
      progressBar.style.width = `${progress}%`;
    }
    
    if (msgEl && message !== null) {
      msgEl.textContent = message;
    }
    
    if (detailsEl && details !== null) {
      detailsEl.textContent = details;
      detailsEl.style.display = details ? 'block' : 'none';
    }
  },
  
  /**
   * Create mobile header
   */
  createMobileHeader: function() {
    // Check if it already exists
    if (document.getElementById('mobileHeader')) return;
    
    // Create the header element
    const mobileHeader = document.createElement('div');
    mobileHeader.id = 'mobileHeader';
    mobileHeader.className = 'mobile-header';
    
    // Add the logo, subtitle, and theme toggle
    mobileHeader.innerHTML = `
      <div class="logo-group mobile-logo">
        <span class="logo-text"><i class="fa-solid fa-flag-usa"></i> FedWon.</span>
        <span class="logo-subtitle">Federal Awards Viewer</span>
      </div>
      <button class="header-button" id="mobileThemeToggle" aria-label="Toggle Theme">
        <i class="fas fa-moon" aria-hidden="true"></i>
      </button>
    `;
    
    // Find where to insert it - at the top of main-content
    const mainContent = document.querySelector('.main-content');
    if (mainContent && mainContent.firstChild) {
      mainContent.insertBefore(mobileHeader, mainContent.firstChild);
    } else if (mainContent) {
      mainContent.appendChild(mobileHeader);
    }
    
    // Set up the mobile theme toggle functionality
    const mobileThemeToggle = document.getElementById('mobileThemeToggle');
    if (mobileThemeToggle) {
      // Sync with current theme
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const icon = mobileThemeToggle.querySelector('i');
      
      if (currentTheme === 'dark') {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
      }
      
      // Add click handler
      App.utils.addEventListenerSafe(mobileThemeToggle, 'click', App.ui.toggleTheme);
    }
  },
  
  /**
   * Initialize mobile navigation
   */
  initMobileNavigation: function() {
    // Only run on mobile devices
    if (!App.support.isMobile()) return;
    
    // Create mobile header
    App.ui.createMobileHeader();
    
    // Set up mobile search
    App.ui.initMobileSearch();
    
    // Element references
    const elements = App.elements;
    
    // Functions to toggle UI elements
    const setActiveButton = function(button) {
      // Remove active class from all buttons
      const buttons = elements.mobileBottomBar.querySelectorAll('.nav-button');
      buttons.forEach(btn => btn.classList.remove('active'));
      
      // Add active class to the clicked button
      button.classList.add('active');
    };
    
    const showSearchBar = function() {
      elements.mobileSearchBar.classList.add('active');
      if (elements.mobileSearchInput) elements.mobileSearchInput.focus();
    };
    
    const hideSearchBar = function() {
      if (elements.mobileSearchBar) elements.mobileSearchBar.classList.remove('active');
    };
    
    const showFilterModal = function() {
      App.utils.handleModal('mobileFilterModal', 'show');
      App.ui.populateMobileFilterModal();
    };
    
    const hideFilterModal = function() {
      App.utils.handleModal('mobileFilterModal', 'hide');
    };
    
    const showDashboard = function() {
      // Show main dashboard content
      if (elements.mainStatusContainer) elements.mainStatusContainer.style.display = 'block';
      if (elements.statsGrid) elements.statsGrid.style.display = 'grid';
      if (elements.dashboardGrid) elements.dashboardGrid.style.display = 'grid';
      
      // Show tables
      document.querySelectorAll('.table-container').forEach(table => {
        table.style.display = 'block';
      });
    };
    
    // Set up event listeners
    if (elements.dashboardBtn) {
      App.utils.addEventListenerSafe(elements.dashboardBtn, 'click', function() {
        setActiveButton(this);
        hideSearchBar();
        hideFilterModal();
        App.utils.handleModal('mobileArchivesModal', 'hide');
        showDashboard();
      });
    }
    
    if (elements.searchBtn) {
      App.utils.addEventListenerSafe(elements.searchBtn, 'click', function() {
        setActiveButton(this);
        showSearchBar();
        hideFilterModal();
        App.utils.handleModal('mobileArchivesModal', 'hide');
      });
    }
    
    if (elements.filterBtn) {
      App.utils.addEventListenerSafe(elements.filterBtn, 'click', function() {
        setActiveButton(this);
        hideSearchBar();
        showFilterModal();
        App.utils.handleModal('mobileArchivesModal', 'hide');
      });
    }
    
    if (elements.archivesBtn) {
      App.utils.addEventListenerSafe(elements.archivesBtn, 'click', function() {
        setActiveButton(this);
        hideSearchBar();
        hideFilterModal();
        App.ui.showMobileArchives();
      });
    }
    
    if (elements.resetBtn) {
      App.utils.addEventListenerSafe(elements.resetBtn, 'click', function() {
        setActiveButton(elements.dashboardBtn); // Reset to dashboard view
        hideSearchBar();
        hideFilterModal();
        App.utils.handleModal('mobileArchivesModal', 'hide');
        App.handlers.handleMobileReset();
      });
    }
    
    if (elements.closeSearchBtn) {
      App.utils.addEventListenerSafe(elements.closeSearchBtn, 'click', function() {
        hideSearchBar();
        setActiveButton(elements.dashboardBtn);
      });
    }
    
    if (elements.closeFilterBtn) {
      App.utils.addEventListenerSafe(elements.closeFilterBtn, 'click', function() {
        hideFilterModal();
        setActiveButton(elements.dashboardBtn);
      });
    }
    
    // Initialize the mobile view
    showDashboard();
  },
  
  /**
   * Initialize mobile search functionality
   */
  initMobileSearch: function() {
    // Get search elements
    const mobileSearchBar = App.elements.mobileSearchBar;
    const mobileSearchInput = App.elements.mobileSearchInput;
    const unifiedSearch = App.elements.unifiedSearch;
    
    if (!mobileSearchBar || !mobileSearchInput) {
      return;
    }
    
    // Function to apply search
    const applyMobileSearch = function() {
      // First, sync with unified search
      if (unifiedSearch) {
        unifiedSearch.value = mobileSearchInput.value;
      }
      
      // Apply the search by calling the global filter function
      if (typeof App.handlers.applyAllFilters === 'function') {
        App.handlers.applyAllFilters();
      }
      
      // Hide the search bar
      mobileSearchBar.classList.remove('active');
      
      // Set dashboard button as active
      const dashboardBtn = App.elements.dashboardBtn;
      if (dashboardBtn) {
        const bottomBar = App.elements.mobileBottomBar;
        if (bottomBar) {
          const buttons = bottomBar.querySelectorAll('.nav-button');
          buttons.forEach(btn => btn.classList.remove('active'));
          dashboardBtn.classList.add('active');
        }
      }
    };
    
    // Add event listener for Enter key
    App.utils.addEventListenerSafe(mobileSearchInput, 'keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault(); // Prevent form submission if in a form
        applyMobileSearch();
      }
    });
    
    // Add search button to the mobile search bar if it doesn't exist
    if (!document.getElementById('mobileSearchSubmitBtn')) {
      const searchSubmitBtn = document.createElement('button');
      searchSubmitBtn.id = 'mobileSearchSubmitBtn';
      searchSubmitBtn.className = 'search-submit-btn';
      searchSubmitBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
      searchSubmitBtn.type = 'button';
      
      // Add the button to the search bar
     const searchInputContainer = mobileSearchBar.querySelector('.search-input-container');
     if (searchInputContainer) {
       searchInputContainer.appendChild(searchSubmitBtn);
     } else {
       mobileSearchBar.appendChild(searchSubmitBtn);
     }
     
     // Add event listener to the button
     App.utils.addEventListenerSafe(searchSubmitBtn, 'click', function(e) {
       e.preventDefault();
       applyMobileSearch();
     });
   }
 },
 
 /**
  * Show mobile archives modal
  */
 showMobileArchives: function() {
   // Check if we already have a mobile archives modal
   let archivesModal = document.getElementById('mobileArchivesModal');
   
   // If not, create one
   if (!archivesModal) {
     archivesModal = document.createElement('div');
     archivesModal.id = 'mobileArchivesModal';
     archivesModal.className = 'mobile-archives-modal';
     
     // Create the modal content
     archivesModal.innerHTML = `
       <div class="modal-header">
         <div class="modal-title">Select Data Period</div>
         <button class="close-button" id="closeArchivesBtn">
           <i class="fas fa-times"></i>
         </button>
       </div>
       <div class="modal-content" id="mobileArchivesContent">
         <!-- This will be populated with archive buttons -->
       </div>
     `;
     
     // Add the modal to the document
     document.body.appendChild(archivesModal);
     
     // Add event listener to close button
     const closeBtn = archivesModal.querySelector('#closeArchivesBtn');
     if (closeBtn) {
       App.utils.addEventListenerSafe(closeBtn, 'click', function() {
         App.utils.handleModal('mobileArchivesModal', 'hide');
       });
     }
   }
   
   // Populate the archives content
   const archivesContent = document.getElementById('mobileArchivesContent');
   if (archivesContent) {
     // Clear existing content
     archivesContent.innerHTML = '';
     
     // Add title and description
     const titleDiv = document.createElement('div');
     titleDiv.className = 'archives-title';
     titleDiv.innerHTML = `
       <h3>Available Data Periods</h3>
       <p>Select a time period to view its contract data</p>
     `;
     archivesContent.appendChild(titleDiv);
     
     // Create buttons container
     const buttonsContainer = document.createElement('div');
     buttonsContainer.className = 'archives-buttons';
     
     // Add current month button
     const currentMonthBtn = document.createElement('button');
     currentMonthBtn.type = 'button';
     currentMonthBtn.className = `archive-month-btn${App.data.currentMonthActive ? ' active' : ''}`;
     currentMonthBtn.innerHTML = `
       <i class="fas fa-calendar-day"></i>
       <span>Current Month</span>
     `;
     
     App.utils.addEventListenerSafe(currentMonthBtn, 'click', function() {
       if (!App.data.currentMonthActive) {
         App.utils.handleModal('mobileArchivesModal', 'hide');
         
         // Show loading indicator
         App.ui.showLoadingIndicator(true, "Loading current month data...");
         
         // Load current month data with a slight delay to allow UI to update
         setTimeout(function() {
           if (typeof App.data.loadCurrentMonthData === 'function') {
             App.data.loadCurrentMonthData();
           } else {
             // Hide loading indicator if we couldn't load data
             App.ui.showLoadingIndicator(false);
           }
         }, 100);
       } else {
         // Already viewing current month, just close the modal
         App.utils.handleModal('mobileArchivesModal', 'hide');
       }
     });
     
     buttonsContainer.appendChild(currentMonthBtn);
     
     // Add archive month buttons if available
     if (App.data.archiveMonths && App.data.archiveMonths.length > 0) {
       App.data.archiveMonths.forEach(function(archiveMonth) {
         // Determine if this archive is currently active
         const isActive = !App.data.currentMonthActive && 
                        App.data.currentDataPeriod && 
                        App.data.currentDataPeriod.startDate && 
                        App.data.currentDataPeriod.startDate.toLocaleString('default', { month: 'long' }) === archiveMonth.month &&
                        App.data.currentDataPeriod.startDate.getFullYear().toString() === archiveMonth.year;
         
         const monthBtn = document.createElement('button');
         monthBtn.type = 'button';
         monthBtn.className = `archive-month-btn${isActive ? ' active' : ''}`;
         monthBtn.innerHTML = `
           <i class="fas fa-calendar-alt"></i>
           <span>${archiveMonth.month} ${archiveMonth.year}</span>
         `;
         
         App.utils.addEventListenerSafe(monthBtn, 'click', function() {
           if (!isActive) {
             App.utils.handleModal('mobileArchivesModal', 'hide');
             
             // Show loading indicator
             App.ui.showLoadingIndicator(true, `Loading ${archiveMonth.month} ${archiveMonth.year} data...`);
             
             // Load archive data with a slight delay to allow UI to update
             setTimeout(function() {
               if (typeof App.data.loadArchivedMonthData === 'function') {
                 App.data.loadArchivedMonthData(archiveMonth);
               } else {
                 // Hide loading indicator if we couldn't load data
                 App.ui.showLoadingIndicator(false);
               }
             }, 100);
           } else {
             // Already viewing this archive, just close the modal
             App.utils.handleModal('mobileArchivesModal', 'hide');
           }
         });
         
         buttonsContainer.appendChild(monthBtn);
       });
     } else {
       // No archives available
       const noArchives = document.createElement('div');
       noArchives.className = 'no-archives';
       noArchives.textContent = 'No archived data periods available';
       buttonsContainer.appendChild(noArchives);
     }
     
     archivesContent.appendChild(buttonsContainer);
   }
   
   // Show the modal
   App.utils.handleModal('mobileArchivesModal', 'show');
 },
 
 /**
  * Populate mobile filter modal with filter options
  */
 populateMobileFilterModal: function() {
   const filterContent = document.getElementById('mobileFilterContent');
   if (!filterContent) return;
   
   // Clear existing content
   filterContent.innerHTML = '';
   
   // Create a function to add filter sections
   function addFilterSection(title, content) {
     const section = document.createElement('div');
     section.className = 'filter-section';
     
     const sectionTitle = document.createElement('div');
     sectionTitle.className = 'filter-section-title';
     sectionTitle.textContent = title;
     
     section.appendChild(sectionTitle);
     section.appendChild(content);
     
     return section;
   }
   
   // Create date filter section
   const dateFilterContent = document.createElement('div');
   dateFilterContent.className = 'date-filter-content';
   
   // Create month filter
   const monthGroup = document.createElement('div');
   monthGroup.className = 'form-group';
   monthGroup.innerHTML = `
     <label class="form-label">Month</label>
     <select id="mobileMonthFilter" class="form-control">
       <option value="">All Months</option>
       <option value="Jan">January</option>
       <option value="Feb">February</option>
       <option value="Mar">March</option>
       <option value="Apr">April</option>
       <option value="May">May</option>
       <option value="Jun">June</option>
       <option value="Jul">July</option>
       <option value="Aug">August</option>
       <option value="Sep">September</option>
       <option value="Oct">October</option>
       <option value="Nov">November</option>
       <option value="Dec">December</option>
     </select>
   `;
   dateFilterContent.appendChild(monthGroup);
   
   // Create year filter
   const yearGroup = document.createElement('div');
   yearGroup.className = 'form-group';
   yearGroup.innerHTML = `
     <label class="form-label">Year</label>
     <select id="mobileYearFilter" class="form-control">
       <option value="">All Years</option>
     </select>
   `;
   dateFilterContent.appendChild(yearGroup);
   
   // Populate year options
   const yearSelect = yearGroup.querySelector('#mobileYearFilter');
   const originalYearFilter = document.getElementById('yearFilter');
   
   if (yearSelect && originalYearFilter) {
     // Copy options from original year filter
     Array.from(originalYearFilter.options).forEach(option => {
       const newOption = document.createElement('option');
       newOption.value = option.value;
       newOption.textContent = option.textContent;
       if (option.selected) newOption.selected = true;
       yearSelect.appendChild(newOption);
     });
   } else {
     // Fallback: add some default years
     const currentYear = new Date().getFullYear();
     for (let year = currentYear; year >= currentYear - 5; year--) {
       const option = document.createElement('option');
       option.value = year;
       option.textContent = year;
       yearSelect.appendChild(option);
     }
   }
   
   // Add date filter section
   filterContent.appendChild(addFilterSection('Date Filters', dateFilterContent));
   
   // Create contract filter section
   const contractFilterContent = document.createElement('div');
   contractFilterContent.className = 'contract-filter-content';
   
   // Add NAICS filter
   const naicsGroup = document.createElement('div');
   naicsGroup.className = 'form-group';
   naicsGroup.innerHTML = `
     <label class="form-label">NAICS Code</label>
     <select id="mobileNaicsFilter" class="form-control">
       <option value="">All NAICS Codes</option>
     </select>
   `;
   contractFilterContent.appendChild(naicsGroup);
   
   // Add Agency filter
   const agencyGroup = document.createElement('div');
   agencyGroup.className = 'form-group';
   agencyGroup.innerHTML = `
     <label class="form-label">Agency</label>
     <select id="mobileAgencyFilter" class="form-control">
       <option value="">All Agencies</option>
     </select>
   `;
   contractFilterContent.appendChild(agencyGroup);
   
   // Add Office filter
   const officeGroup = document.createElement('div');
   officeGroup.className = 'form-group';
   officeGroup.innerHTML = `
     <label class="form-label">Office</label>
     <select id="mobileOfficeFilter" class="form-control">
       <option value="">All Offices</option>
     </select>
   `;
   contractFilterContent.appendChild(officeGroup);
   
   // Add Vendor filter
   const vendorGroup = document.createElement('div');
   vendorGroup.className = 'form-group';
   vendorGroup.innerHTML = `
     <label class="form-label">Vendor</label>
     <select id="mobileVendorFilter" class="form-control">
       <option value="">All Vendors</option>
     </select>
   `;
   contractFilterContent.appendChild(vendorGroup);
   
   // Add contract filter section
   filterContent.appendChild(addFilterSection('Contract Filters', contractFilterContent));
   
   // Populate filter dropdowns from original filters
   const filterMap = {
     'naicsFilter': 'mobileNaicsFilter',
     'agencyFilter': 'mobileAgencyFilter',
     'officeFilter': 'mobileOfficeFilter',
     'vendorFilter': 'mobileVendorFilter',
     'monthFilter': 'mobileMonthFilter',
     'yearFilter': 'mobileYearFilter'
   };
   
   // Copy options from original filters to mobile filters
   for (const [originalId, mobileId] of Object.entries(filterMap)) {
     const originalFilter = document.getElementById(originalId);
     const mobileFilter = document.getElementById(mobileId);
     
     if (originalFilter && mobileFilter) {
       // First remove all options except the first one (All...)
       while (mobileFilter.options.length > 1) {
         mobileFilter.remove(1);
       }
       
       // Then copy options from original filter
       Array.from(originalFilter.options).forEach((option, index) => {
         if (index === 0) {
           // Keep the first option but sync its selection state
           mobileFilter.options[0].selected = option.selected;
         } else {
           const newOption = document.createElement('option');
           newOption.value = option.value;
           newOption.textContent = option.textContent;
           newOption.selected = option.selected;
           mobileFilter.appendChild(newOption);
         }
       });
     }
   }
   
   // Add buttons
   const buttonContainer = document.createElement('div');
   buttonContainer.className = 'filter-buttons';
   buttonContainer.innerHTML = `
     <button id="mobileApplyFiltersBtn" class="btn btn-primary">Apply Filters</button>
     <button id="mobileClearFiltersBtn" class="btn btn-secondary">Clear Filters</button>
   `;
   filterContent.appendChild(buttonContainer);
   
   // Add event listeners to buttons
   const applyBtn = document.getElementById('mobileApplyFiltersBtn');
   const clearBtn = document.getElementById('mobileClearFiltersBtn');
   
   if (applyBtn) {
     App.utils.addEventListenerSafe(applyBtn, 'click', function() {
       // Sync mobile filters to original filters
       for (const [originalId, mobileId] of Object.entries(filterMap)) {
         const originalFilter = document.getElementById(originalId);
         const mobileFilter = document.getElementById(mobileId);
         
         if (originalFilter && mobileFilter) {
           originalFilter.value = mobileFilter.value;
         }
       }
       
       // Apply filters
       if (typeof App.handlers.applyAllFilters === 'function') {
         App.handlers.applyAllFilters();
       }
       
       // Hide modal
       App.utils.handleModal('mobileFilterModal', 'hide');
       
       // Set dashboard button as active
       const dashboardBtn = document.getElementById('dashboardBtn');
       if (dashboardBtn) {
         const bottomBar = document.getElementById('mobileBottomBar');
         if (bottomBar) {
           const buttons = bottomBar.querySelectorAll('.nav-button');
           buttons.forEach(btn => btn.classList.remove('active'));
           dashboardBtn.classList.add('active');
         }
       }
     });
   }
   
   if (clearBtn) {
     App.utils.addEventListenerSafe(clearBtn, 'click', function() {
       // Reset all mobile filters
       for (const mobileId of Object.values(filterMap)) {
         const mobileFilter = document.getElementById(mobileId);
         if (mobileFilter) {
           mobileFilter.selectedIndex = 0;
         }
       }
     });
   }
 },
 
 /**
  * Update UI for archive months
  */
 updateArchiveMonthsUI: function(currentMonthActive, activeArchive = null) {
   // Only update if this is auto-loaded data
   if (!App.data.isAutoLoadedData) {
     return;
   }
   
   const archiveMonthsList = document.getElementById('archiveMonthsList');
   if (!archiveMonthsList) return;
   
   // Clear existing buttons
   archiveMonthsList.innerHTML = '';
   
   // Add current month button
   const currentMonthBtn = document.createElement('button');
   currentMonthBtn.className = `archive-month-btn${currentMonthActive ? ' active' : ''}`;
   currentMonthBtn.textContent = 'Current Month';
   App.utils.addEventListenerSafe(currentMonthBtn, 'click', function() {
     if (!App.data.currentMonthActive) {
       App.data.loadCurrentMonthData();
     }
   });
   archiveMonthsList.appendChild(currentMonthBtn);
   
   // Add archive month buttons
   App.data.archiveMonths.forEach(archiveMonth => {
     const isActive = !currentMonthActive && 
                    activeArchive && 
                    activeArchive.month === archiveMonth.month && 
                    activeArchive.year === archiveMonth.year;
     
     const monthBtn = document.createElement('button');
     monthBtn.className = `archive-month-btn${isActive ? ' active' : ''}`;
     monthBtn.textContent = `${archiveMonth.month} ${archiveMonth.year}`;
     App.utils.addEventListenerSafe(monthBtn, 'click', function() {
       // Check if this month is already active
       if (!isActive) {
         App.data.loadArchivedMonthData(archiveMonth);
       }
     });
     
     archiveMonthsList.appendChild(monthBtn);
   });
 },
 
 /**
  * Show or hide the data context info
  */
 hideDataContextInfo: function() {
   const dataContextInfo = document.getElementById('dataContextInfo');
   const archiveMonthsContainer = document.getElementById('archiveMonthsContainer');
   
   if (dataContextInfo) {
     dataContextInfo.style.display = 'none';
   }
   
   if (archiveMonthsContainer) {
     archiveMonthsContainer.style.display = 'none';
   }
 },
 
 showDataContextInfo: function() {
   const dataContextInfo = document.getElementById('dataContextInfo');
   const archiveMonthsContainer = document.getElementById('archiveMonthsContainer');
   
   if (dataContextInfo) {
     dataContextInfo.style.display = 'flex';
   }
   
   if (archiveMonthsContainer) {
     archiveMonthsContainer.style.display = 'flex';
   }
 },
 
 /**
  * Update data context information
  */
 updateDataContext: function() {
   if (!App.data.currentDataPeriod) return;
   
   // Only update if this is auto-loaded data
   if (!App.data.isAutoLoadedData) {
     // Hide elements for non-auto-loaded data
     App.ui.hideDataContextInfo();
     return;
   }
   
   // Show elements for auto-loaded data
   App.ui.showDataContextInfo();
   
   const contextMonth = document.getElementById('contextMonth');
   const contextDate = document.getElementById('contextDate');
   
   if (contextMonth && contextDate) {
     const month = App.data.currentDataPeriod.startDate.toLocaleString('default', { month: 'long' });
     const year = App.data.currentDataPeriod.startDate.getFullYear();
     const lastDate = App.data.currentDataPeriod.endDate.toLocaleDateString('en-US', {
       month: 'long',
       day: 'numeric'
     });
     
     contextMonth.textContent = `${month} ${year}`;
     contextDate.textContent = lastDate;
   }
 }
};

/**
* Chart management functions
*/
App.charts = {
 /**
  * Initialize all charts
  */
 initCharts: function() {
   // Destroy any existing charts first
   for (var key in App.data.charts) {
     if (App.data.charts[key] instanceof Chart) {
       App.data.charts[key].destroy();
     }
   }
   
   // Reset charts object
   App.data.charts = {};
   
   // Define chart options with modern styling
   Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, sans-serif";
   Chart.defaults.color = '#6B7280';
   
   try {
     // Initialize charts
     App.charts.initMonthlyChart();
     App.charts.initVendorChart();
     App.charts.initSizeChart();
     App.charts.initContractTypeChart();
   } catch (error) {
     App.handleError("chart initialization", error, "Error initializing charts. Please try reloading the page.");
   }
 },
 
 /**
  * Initialize Monthly chart
  */
 initMonthlyChart: function() {
   var canvas = document.getElementById('monthlyChart');
   if (!canvas) {
     return;
   }
   
   var ctx = canvas.getContext('2d');
   App.data.charts.monthly = new Chart(ctx, {
     type: 'line',
     data: {
       labels: ['No Data'],
       datasets: [{
         label: 'Contract Awards',
         data: [0],
         borderColor: '#4F46E5',
         backgroundColor: 'rgba(79, 70, 229, 0.1)',
         tension: 0.4,
         fill: true,
         pointBackgroundColor: '#4F46E5',
         pointBorderColor: '#fff',
         pointBorderWidth: 2,
         pointRadius: 4,
         pointHoverRadius: 6
       }]
     },
     options: {
       responsive: true,
       maintainAspectRatio: false,
       plugins: {
         legend: {
           display: false
         },
         tooltip: {
           backgroundColor: 'rgba(17, 24, 39, 0.95)',
           titleColor: '#F9FAFB',
           bodyColor: '#D1D5DB',
           borderColor: '#374151',
           borderWidth: 1,
           padding: 12,
           cornerRadius: 8
         }
       },
       scales: {
         x: {
           grid: {
             display: false
           },
           ticks: {
             font: {
               size: 11
             }
           }
         },
         y: {
           beginAtZero: true,
           grid: {
             color: 'rgba(107, 114, 128, 0.1)',
             drawBorder: false
           },
           ticks: {
             font: {
               size: 11
             }
           }
         }
       }
     }
   });
 },
 
 /**
  * Initialize Vendor chart
  */
 initVendorChart: function() {
   var canvas = document.getElementById('vendorChart');
   if (!canvas) {
     return;
   }
   
   var ctx = canvas.getContext('2d');
   App.data.charts.vendor = new Chart(ctx, {
     type: 'bar',
     data: {
       labels: ['No Data'],
       datasets: [{
         label: 'Contract Value',
         data: [0],
         backgroundColor: [
           '#667eea', '#764ba2', '#f093fb', '#f5576c', 
           '#4facfe', '#43e97b', '#a8eb12', '#ebbf12'
         ],
         borderWidth: 0,
         borderRadius: {
           topLeft: 4,
           topRight: 4,
           bottomLeft: 0,
           bottomRight: 0
         },
         barPercentage: 0.8,
         categoryPercentage: 0.9
       }]
     },
     options: {
       responsive: true,
       maintainAspectRatio: false,
       plugins: {
         legend: {
           display: false
         },
         tooltip: {
           backgroundColor: 'rgba(17, 24, 39, 0.95)',
           titleColor: '#F9FAFB',
           bodyColor: '#D1D5DB',
           borderColor: '#374151',
           borderWidth: 1,
           padding: 12,
           cornerRadius: 8,
           callbacks: {
             label: function(context) {
               return App.utils.formatCurrency(context.raw);
             }
           }
         }
       },
       scales: {
         x: {
           grid: {
             display: false
           },
           ticks: {
             font: {
               size: 10
             },
             maxRotation: 45,
             minRotation: 45
           }
         },
         y: {
           beginAtZero: true,
           grid: {
             color: 'rgba(107, 114, 128, 0.1)',
             drawBorder: false
           },
           position: 'left',
           ticks: {
             font: {
               size: 10
             },
             callback: function(value) {
               return App.utils.formatCurrency(value);
             }
           }
         }
       },
       onClick: function(event, elements) {
         if (elements.length > 0) {
           const index = elements[0].index;
           const vendorName = this.data.labels[index];
           App.handlers.filterByVendorName(vendorName);
         }
       },
       onHover: function(event, elements) {
         event.native.target.style.cursor = elements.length ? 'pointer' : 'default';
       }
     }
   });
 },
 
 /**
  * Initialize Size chart
  */
 initSizeChart: function() {
   var canvas = document.getElementById('sizeChart');
   if (!canvas) {
     return;
   }
   
   var ctx = canvas.getContext('2d');
   App.data.charts.size = new Chart(ctx, {
     type: 'pie',
     data: {
       labels: ['No Data'],
       datasets: [{
         data: [1],
         backgroundColor: ['#E5E7EB']
       }]
     },
     options: {
       responsive: true,
       maintainAspectRatio: false,
       plugins: {
         legend: {
           position: 'bottom',
           labels: {
             boxWidth: 12,
             padding: 10,
             usePointStyle: true,
             font: {
               size: 11,
               weight: 500
             }
           }
         },
         tooltip: {
           backgroundColor: 'rgba(17, 24, 39, 0.95)',
           titleColor: '#F9FAFB',
           bodyColor: '#D1D5DB',
           borderColor: '#374151',
           borderWidth: 1,
           padding: 12,
           cornerRadius: 8
         }
       }
     }
   });
 },
 
 /**
  * Initialize Contract Type chart
  */
 initContractTypeChart: function() {
   var canvas = document.getElementById('contractTypeChart');
   if (!canvas) {
     return;
   }
   
   var ctx = canvas.getContext('2d');
   App.data.charts.contractType = new Chart(ctx, {
     type: 'bar',
     data: {
       labels: ['No Data'],
       datasets: [{
         label: 'Count',
         data: [0],
         backgroundColor: '#4F46E5',
         borderRadius: 6,
         barThickness: 'flex',
         maxBarThickness: 50
       }]
     },
     options: {
       responsive: true,
       maintainAspectRatio: false,
       plugins: {
         legend: {
           display: false
         },
         tooltip: {
           backgroundColor: 'rgba(17, 24, 39, 0.95)',
           titleColor: '#F9FAFB',
           bodyColor: '#D1D5DB',
           borderColor: '#374151',
           borderWidth: 1,
           padding: 12,
           cornerRadius: 8
         }
       },
       scales: {
         x: {
           grid: {
             display: false
           },
           ticks: {
             font: {
               size: 11
             }
           }
         },
         y: {
           beginAtZero: true,
           grid: {
             color: 'rgba(107, 114, 128, 0.1)',
             drawBorder: false
           },
           ticks: {
             font: {
               size: 11
             }
           }
         }
       }
     }
   });
 },
 
 /**
  * Update chart colors based on theme
  */
 updateColors: function() {
   const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
   const textColor = isDarkMode ? '#e2e8f0' : '#6B7280';
   const gridColor = isDarkMode ? 'rgba(74, 85, 104, 0.2)' : 'rgba(107, 114, 128, 0.1)';
   
   // Update each chart's text colors
   if (App.data.charts.monthly) {
     App.data.charts.monthly.options.scales.x.ticks.color = textColor;
     App.data.charts.monthly.options.scales.y.ticks.color = textColor;
     App.data.charts.monthly.update();
   }
   
   if (App.data.charts.vendor) {
     App.data.charts.vendor.options.scales.x.ticks.color = textColor;
     App.data.charts.vendor.options.scales.y.ticks.color = textColor;
     App.data.charts.vendor.update();
   }
   
   if (App.data.charts.contractType) {
     App.data.charts.contractType.options.scales.x.ticks.color = textColor;
     App.data.charts.contractType.options.scales.y.ticks.color = textColor;
     App.data.charts.contractType.update();
   }
   
   if (App.data.charts.size && App.data.charts.size.options.plugins && App.data.charts.size.options.plugins.legend) {
     if (!App.data.charts.size.options.plugins.legend.labels) {
       App.data.charts.size.options.plugins.legend.labels = {};
     }
     App.data.charts.size.options.plugins.legend.labels.color = textColor;
     App.data.charts.size.update();
   }
 },
 
 /**
  * Update Monthly chart with data
  */
 updateMonthlyChart: function() {
   // Check if chart exists
   if (!App.data.charts.monthly) {
     return;
   }
   
   try {
     // Group by month
     var monthlyData = {};
     
     for (var i = 0; i < App.data.filteredData.length; i++) {
       if (App.data.filteredData[i].date) {
         var date = App.utils.parseDate(App.data.filteredData[i].date);
         if (date) {
           var monthYear = date.getFullYear() + '-' + (date.getMonth() + 1);
           
           if (!monthlyData[monthYear]) {
             monthlyData[monthYear] = 0;
           }
           
           monthlyData[monthYear]++;
         }
       }
     }
     
     // Handle empty data case
     if (Object.keys(monthlyData).length === 0) {
       App.data.charts.monthly.data.labels = ['No Data'];
       App.data.charts.monthly.data.datasets[0].data = [0];
       App.data.charts.monthly.update();
       return;
     }
     
     // Convert to arrays and sort by date
     var sortedMonths = Object.keys(monthlyData).sort();
     
     var labels = [];
     var data = [];
     
     for (var i = 0; i < sortedMonths.length; i++) {
       var parts = sortedMonths[i].split('-');
       var year = parts[0];
       var month = parts[1];
       
       var date = new Date(year, month - 1);
       var monthName = date.toLocaleString('default', { month: 'short' });
       
       labels.push(monthName + ' ' + year.substr(2));
       data.push(monthlyData[sortedMonths[i]]);
     }
     
     // Update chart safely
     App.data.charts.monthly.data.labels = labels;
     App.data.charts.monthly.data.datasets[0].data = data;
     
     // Ensure chart is rendered
     App.data.charts.monthly.update('none'); // Use 'none' for no animation to improve performance
   } catch (error) {
     App.handleError("updating monthly chart", error);
     
     // Try to recover by resetting the chart
     try {
       App.data.charts.monthly.data.labels = ['Error'];
       App.data.charts.monthly.data.datasets[0].data = [0];
       App.data.charts.monthly.update();
     } catch (e) {
       // If all else fails, report the error
       App.handleError("recovering monthly chart", e);
     }
   }
 },
 
 /**
  * Update Contract Type chart with data
  */
 updateContractTypeChart: function() {
   // Group by contract type
   var typeData = {};
   
   for (var i = 0; i < App.data.filteredData.length; i++) {
     var type = App.data.filteredData[i].type || 'Unknown';
     
     if (!typeData[type]) {
       typeData[type] = 0;
     }
     
     typeData[type]++;
   }
   
   // Convert to array and sort
   var typeArray = [];
   
   for (var type in typeData) {
     typeArray.push({
       name: type,
       count: typeData[type]
     });
   }
   
   typeArray.sort(function(a, b) {
     return b.count - a.count;
   });
   
   var labels = [];
   var data = [];
   
   for (var i = 0; i < typeArray.length; i++) {
     var name = typeArray[i].name;
     
     if (name.length > 15) {
       name = name.substring(0, 12) + '...';
     }
     
     labels.push(name);
     data.push(typeArray[i].count);
   }
   
   var colors = [];
   for (var i = 0; i < labels.length; i++) {
     colors.push('#667eea');
   }
   
   // Update chart
   App.data.charts.contractType.data.labels = labels;
   App.data.charts.contractType.data.datasets[0].data = data;
   App.data.charts.contractType.data.datasets[0].backgroundColor = colors;
   App.data.charts.contractType.update();
 },
 
 /**
  * Update Size chart with data
  */
 updateSizeChart: function() {
   // Categorize by contract value
   var sizeCategories = {
     'Under $100K': 0,
     '$100K-$500K': 0,
     '$500K-$1M': 0,
     '$1M-$5M': 0,
     'Over $5M': 0
   };
   
   for (var i = 0; i < App.data.filteredData.length; i++) {
     var value = App.data.filteredData[i].value;
     
     if (value < 100000) {
       sizeCategories['Under $100K']++;
     } else if (value < 500000) {
       sizeCategories['$100K-$500K']++;
     } else if (value < 1000000) {
       sizeCategories['$500K-$1M']++;
     } else if (value < 5000000) {
       sizeCategories['$1M-$5M']++;
     } else {
       sizeCategories['Over $5M']++;
     }
   }
   
   var labels = Object.keys(sizeCategories);
   var data = [];
   
   for (var i = 0; i < labels.length; i++) {
     data.push(sizeCategories[labels[i]]);
   }
   
   var colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'];
   
   // Update chart
   App.data.charts.size.data.labels = labels;
   App.data.charts.size.data.datasets[0].data = data;
   App.data.charts.size.data.datasets[0].backgroundColor = colors;
   App.data.charts.size.update();
 },
 
 /**
  * Update Vendor chart with data
  */
 updateVendorChart: function() {
   // Group by vendor
   var vendorData = {};
   
   for (var i = 0; i < App.data.filteredData.length; i++) {
     var vendor = App.data.filteredData[i].vendor || 'Unknown';
     
     // Truncate long vendor names
     if (vendor.length > 12) {
       vendor = vendor.substring(0, 10) + '...';
     }
     
     if (!vendorData[vendor]) {
       vendorData[vendor] = 0;
     }
     
     vendorData[vendor] += App.data.filteredData[i].value;
   }
   
   // Convert to array and sort
   var vendorArray = [];
   
   for (var vendor in vendorData) {
     vendorArray.push({
       name: vendor,
       value: vendorData[vendor]
     });
   }
   
   vendorArray.sort(function(a, b) {
     return b.value - a.value;
   });
   
   // Take top 8 vendors (adjust as needed)
   var topVendors = vendorArray.slice(0, 8);
   
   // Prepare chart data
   var labels = [];
   var data = [];
   var backgroundColors = [];
   
   for (var i = 0; i < topVendors.length; i++) {
     labels.push(topVendors[i].name);
     data.push(topVendors[i].value);
   }
   
   // Get chart colors
   var chartColors = [
     '#667eea', '#764ba2', '#f093fb', '#f5576c', 
     '#4facfe', '#43e97b', '#a8eb12', '#ebbf12'
   ];
   
   // Assign colors
   for (var i = 0; i < labels.length; i++) {
     backgroundColors.push(chartColors[i % chartColors.length]);
   }
   
   // Update chart
   App.data.charts.vendor.data.labels = labels;
   App.data.charts.vendor.data.datasets[0].data = data;
   App.data.charts.vendor.data.datasets[0].backgroundColor = backgroundColors;
   App.data.charts.vendor.update();
 },
 
 /**
  * Update all charts
  */
 updateAllCharts: function() {
   try {
     App.charts.updateMonthlyChart();
     App.charts.updateContractTypeChart();
     App.charts.updateSizeChart();
     App.charts.updateVendorChart();
   } catch (error) {
     App.handleError("updating charts", error, "Error updating charts. Try reloading the page.");
   }
 },
 
 /**
  * Set up dashboard grid for charts
  */
 setupDashboardGrid: function() {
   const dashboardGrid = document.querySelector('.dashboard-grid');
   if (!dashboardGrid) {
     return;
   }

   dashboardGrid.innerHTML = ''; // Clear the grid

   // Check if we are in a mobile view
   const isMobileView = window.innerWidth < 768;

   const CHART_HEIGHT_DESKTOP = '550px'; // Used for vendor chart and Sankey on desktop

   // First row: Vendor Chart (1/3) + Sankey Chart placeholder (2/3)
   const vendorCard = App.charts.createChartCard('vendorChart', 'Top Vendors by Value', 'fa-building');
   // These JS-set grid positions are for desktop; mobile CSS with !important overrides them.
   vendorCard.style.gridColumn = '1 / 2';
   vendorCard.style.gridRow = '1 / 2';
   if (!isMobileView) { // Only apply fixed height for desktop view
     vendorCard.style.height = CHART_HEIGHT_DESKTOP;
   }
   dashboardGrid.appendChild(vendorCard);

   const sankeyPlaceholder = document.createElement('div');
   sankeyPlaceholder.id = 'sankeyPlaceholder';
   // JS-set grid positions for desktop
   sankeyPlaceholder.style.gridColumn = '2 / 4';
   sankeyPlaceholder.style.gridRow = '1 / 2';
   if (!isMobileView) { // Only apply fixed height for desktop view
     sankeyPlaceholder.style.height = CHART_HEIGHT_DESKTOP;
   }
   dashboardGrid.appendChild(sankeyPlaceholder);

   // Second row: Three equal charts
   const sizeCard = App.charts.createChartCard('sizeChart', 'Contract Size Distribution', 'fa-chart-bar');
   sizeCard.style.gridColumn = '1 / 2'; // JS-set grid positions for desktop
   sizeCard.style.gridRow = '2 / 3';
   dashboardGrid.appendChild(sizeCard);

   const typeCard = App.charts.createChartCard('contractTypeChart', 'Contract Types', 'fa-tags');
   typeCard.style.gridColumn = '2 / 3'; // JS-set grid positions for desktop
   typeCard.style.gridRow = '2 / 3';
   dashboardGrid.appendChild(typeCard);

   const monthlyCard = App.charts.createChartCard('monthlyChart', 'Monthly Trends', 'fa-calendar-alt');
   monthlyCard.style.gridColumn = '3 / 4'; // JS-set grid positions for desktop
   monthlyCard.style.gridRow = '2 / 3';
   dashboardGrid.appendChild(monthlyCard);
 },
 
 /**
  * Create a chart card element
  */
 createChartCard: function(chartId, title, icon) {
   const card = document.createElement('div');
   card.className = 'card';
   
   // Card header
   const header = document.createElement('div');
   header.className = 'card-header';
   
   // Card title
   const titleElement = document.createElement('h3');
   titleElement.className = 'card-title';
   titleElement.innerHTML = title;
   
   header.appendChild(titleElement);
   card.appendChild(header);
   
   // Chart container
   const chartContainer = document.createElement('div');
   chartContainer.className = 'chart-container';
   
   // Special handling for vendor chart to anchor it to the bottom
   if (chartId === 'vendorChart') {
     chartContainer.style.height = 'calc(100% - 62px)'; // Subtract header height
     chartContainer.style.display = 'flex';
     chartContainer.style.flexDirection = 'column';
     chartContainer.style.justifyContent = 'flex-end'; // Align to bottom
   }
   
   // Canvas for chart
   const canvas = document.createElement('canvas');
   canvas.id = chartId;
   
   chartContainer.appendChild(canvas);
   card.appendChild(chartContainer);
   
   return card;
 }
};

/**
* Sankey diagram functions
*/
App.sankey = {
 /**
  * Create Sankey diagram
  */
 createSankeyDiagram: function() {
   // Check if we already have a Sankey container
   let sankeyContainer = document.getElementById('sankeyContainer');
   if (sankeyContainer) {
     // Clear its contents but keep the container
     sankeyContainer.innerHTML = '';
   } else {
     // Create a new container
     sankeyContainer = document.createElement('div');
     sankeyContainer.id = 'sankeyContainer';
     sankeyContainer.className = 'card';
     
     // Find the placeholder and replace it
     const placeholder = document.getElementById('sankeyPlaceholder');
     if (placeholder) {
       // Ensure the container inherits the grid position from the placeholder
       sankeyContainer.style.gridColumn = '2 / 4'; // Span columns 2-3
       sankeyContainer.style.gridRow = '1 / 2';    // First row
       sankeyContainer.style.height = placeholder.style.height; // Same height as placeholder
       placeholder.parentNode.replaceChild(sankeyContainer, placeholder);
     } else {
       // Fallback handling
       const dashboardGrid = document.querySelector('.dashboard-grid');
       if (dashboardGrid) {
         sankeyContainer.style.gridColumn = '2 / 4';
         sankeyContainer.style.gridRow = '1 / 2';
         dashboardGrid.appendChild(sankeyContainer);
       }
     }
   }
   
   // Add header
   const header = document.createElement('div');
   header.className = 'card-header';
   header.innerHTML = `
     <h3 class="card-title">
       Funding Flow: Agency → Office → Vendor
     </h3>
   `;
   sankeyContainer.appendChild(header);
   
   // Add chart container with height calculation
   const chartContainer = document.createElement('div');
   chartContainer.id = 'sankeyChart';

   // Height logic for chartContainer
   if (window.innerWidth < 768) {
     chartContainer.style.height = '320px';
   } else {
     chartContainer.style.height = 'calc(100% - 120px)'; // Assuming 120px for header + controls
   }

   chartContainer.style.width = '100%';
   chartContainer.style.overflow = 'hidden';
   chartContainer.style.position = 'relative';
   sankeyContainer.appendChild(chartContainer);
   
   // Add controls at bottom
   const controls = document.createElement('div');
   controls.className = 'filter-actions';
   controls.style.marginTop = '10px';
   controls.style.display = 'flex';
   controls.style.flexDirection = 'row'; // Make buttons horizontal
   controls.style.justifyContent = 'center';
   controls.style.gap = '10px';
   controls.style.height = '36px'; // Fixed height for the button row
   controls.innerHTML = `
     <button class="btn btn-secondary" id="sankeyTop10">
       Top 10 Flows
     </button>
     <button class="btn btn-secondary active" id="sankeyTop25">
       Top 25 Flows
     </button>
     <button class="btn btn-secondary" id="sankeyAll">
       Show All
     </button>
   `;
   sankeyContainer.appendChild(controls);
   
   if (window.innerWidth < 768) {
     const buttons = sankeyContainer.querySelectorAll('button');
     buttons.forEach(button => {
       button.style.display = 'inline-flex';
       button.style.visibility = 'visible';
       button.style.opacity = '1';
     });
     
     // Make container taller on mobile
     sankeyContainer.style.minHeight = '400px';
   }
   
   window.removeEventListener('resize', App.sankey.handleResize);
   window.addEventListener('resize', App.sankey.handleResize);
   
   // Add event listeners to control buttons
   App.utils.addEventListenerSafe(document.getElementById('sankeyTop10'), 'click', function() {
     App.data.currentSankeyLimit = 10;
     App.sankey.updateButtonStates();
     App.sankey.updateWithFilteredData();
   });
   
   App.utils.addEventListenerSafe(document.getElementById('sankeyTop25'), 'click', function() {
     App.data.currentSankeyLimit = 25;
     App.sankey.updateButtonStates();
     App.sankey.updateWithFilteredData();
   });
   
   App.utils.addEventListenerSafe(document.getElementById('sankeyAll'), 'click', function() {
     App.data.currentSankeyLimit = 0;
     App.sankey.updateButtonStates();
     App.sankey.updateWithFilteredData();
   });
   
   // Set initial button state
   App.sankey.updateButtonStates();
   
   // Update diagram with filtered data
   App.sankey.updateWithFilteredData();
 },
 
 /**
  * Handle resize event for Sankey diagram
  */
 handleResize: function() {
   const sankeyChart = document.getElementById('sankeyChart');
   if (!sankeyChart || sankeyChart.offsetWidth === 0 || sankeyChart.offsetHeight === 0) {
     return;
   }

   clearTimeout(window.sankeySpecificResizeTimer);
   window.sankeySpecificResizeTimer = setTimeout(function() {
     App.sankey.updateWithFilteredData();
   }, 250); // 250ms debounce
 },
 
 /**
  * Update Sankey button states
  */
 updateButtonStates: function() {
   const top10Button = document.getElementById('sankeyTop10');
   const top25Button = document.getElementById('sankeyTop25');
   const allButton = document.getElementById('sankeyAll');
   
   if (!top10Button || !top25Button || !allButton) return;
   
   // Remove active class from all buttons
   top10Button.classList.remove('active');
   top25Button.classList.remove('active');
   allButton.classList.remove('active');
   
   // Add active class to correct button based on current limit
   if (App.data.currentSankeyLimit === 10) {
     top10Button.classList.add('active');
   } else if (App.data.currentSankeyLimit === 25 || App.data.currentSankeyLimit === undefined) {
     top25Button.classList.add('active');
   } else if (App.data.currentSankeyLimit === 0) {
     allButton.classList.add('active');
   }
 },
 
 /**
  * Update Sankey diagram with filtered data
  */
 updateWithFilteredData: function() {
   if (App.data.filteredData.length === 0) {
     const chartContainer = document.getElementById('sankeyChart');
     if (chartContainer) {
       chartContainer.innerHTML = '<div style="padding: 20px; text-align: center;">No data matches the current filters.</div>';
     }
     return;
   }
   
   // Prepare Sankey data with filtered data
   const sankeyData = App.sankey.prepareData(App.data.filteredData);
   
   // Filter to top flows if needed
   const filteredSankeyData = App.sankey.filterData(sankeyData, App.data.currentSankeyLimit);
   
   // Render the diagram
   App.sankey.renderDiagram(filteredSankeyData, 'sankeyChart');
 },
 
 /**
  * Prepare Sankey diagram data from contract data
  */
 prepareData: function(data) {
   // Maps for unique nodes
   const agencyNodes = new Map();
   const officeNodes = new Map();
   const vendorNodes = new Map();
   
   // Flow data
   const agencyToOfficeLinks = new Map();
   const officeToVendorLinks = new Map();
   
   // Process each contract
   for (const item of data) {
     // Skip contracts with no value
     if (!item.value || item.value <= 0) continue;
     
     // Get the entities
     const agency = item.agency || 'Unknown Agency';
     const office = item.office || 'Unknown Office';
     const vendor = item.vendor || 'Unknown Vendor';
     
     // Track nodes
     if (!agencyNodes.has(agency)) {
       agencyNodes.set(agency, { name: agency, value: 0 });
     }
     if (!officeNodes.has(office)) {
       officeNodes.set(office, { name: office, value: 0 });
     }
     if (!vendorNodes.has(vendor)) {
       vendorNodes.set(vendor, { name: vendor, value: 0 });
     }
     
     // Update node values
     agencyNodes.get(agency).value += item.value;
     officeNodes.get(office).value += item.value;
     vendorNodes.get(vendor).value += item.value;
     
     // Track links
     const agencyOfficeKey = `${agency}|${office}`;
     const officeVendorKey = `${office}|${vendor}`;
     
     if (!agencyToOfficeLinks.has(agencyOfficeKey)) {
       agencyToOfficeLinks.set(agencyOfficeKey, 0);
     }
     if (!officeToVendorLinks.has(officeVendorKey)) {
       officeToVendorLinks.set(officeVendorKey, 0);
     }
     
     // Update link values
     agencyToOfficeLinks.set(agencyOfficeKey, agencyToOfficeLinks.get(agencyOfficeKey) + item.value);
     officeToVendorLinks.set(officeVendorKey, officeToVendorLinks.get(officeVendorKey) + item.value);
   }
   
   // Create nodes array with correct indices
   const nodes = [];
   
   // Add agency nodes first
   const agencyIndices = new Map();
   for (const [agency, data] of agencyNodes.entries()) {
     const index = nodes.length;
     agencyIndices.set(agency, index);
     nodes.push({ id: index, name: data.name });
   }
   
   // Add office nodes next
   const officeIndices = new Map();
   for (const [office, data] of officeNodes.entries()) {
     const index = nodes.length;
     officeIndices.set(office, index);
     nodes.push({ id: index, name: data.name });
   }
   
   // Add vendor nodes last
   const vendorIndices = new Map();
   for (const [vendor, data] of vendorNodes.entries()) {
     const index = nodes.length;
     vendorIndices.set(vendor, index);
     nodes.push({ id: index, name: data.name });
   }
   
   // Create links array
   const links = [];
   
   // Add agency to office links
   for (const [key, value] of agencyToOfficeLinks.entries()) {
     const [agency, office] = key.split('|');
     links.push({
       source: agencyIndices.get(agency),
       target: officeIndices.get(office),
       value: value
     });
   }
   
   // Add office to vendor links
   for (const [key, value] of officeToVendorLinks.entries()) {
     const [office, vendor] = key.split('|');
     links.push({
       source: officeIndices.get(office),
       target: vendorIndices.get(vendor),
       value: value
     });
   }
   
   return { nodes, links };
 },
 
 /**
  * Filter Sankey data to top N flows
  */
 filterData: function(data, limit = 0) {
   if (!limit || limit <= 0) return data;
   
   // Sort links by value in descending order
   const sortedLinks = [...data.links].sort((a, b) => b.value - a.value);
   
   // Take top N links
   const topLinks = sortedLinks.slice(0, limit);
   
   // Create a set of node IDs used in the top links
   const usedNodeIds = new Set();
   for (const link of topLinks) {
     usedNodeIds.add(link.source);
     usedNodeIds.add(link.target);
   }
   
   // Filter nodes to only include those used in the top links
   const filteredNodes = data.nodes.filter(node => usedNodeIds.has(node.id));
   
   // Remap node IDs to be consecutive
   const nodeMap = new Map();
   filteredNodes.forEach((node, index) => {
     nodeMap.set(node.id, index);
     node.id = index;
   });
   
   // Remap source and target in links
   const remappedLinks = topLinks.map(link => ({
     source: nodeMap.get(link.source),
     target: nodeMap.get(link.target),
     value: link.value
   }));
   
   return {
     nodes: filteredNodes,
     links: remappedLinks
   };
 },
 
 /**
  * Render Sankey diagram
  */
 renderDiagram: function(data, containerId) {
   // Get container
   const container = document.getElementById(containerId);
   if (!container) {
     return;
   }
   
   // Clear container
   container.innerHTML = '';
   
   // Check if we have data
   if (!data || !data.nodes || data.nodes.length === 0 || !data.links || data.links.length === 0) {
     container.innerHTML = '<div style="text-align: center; padding: 50px;">No data available for Sankey diagram</div>';
     return;
   }
   
   // Get the vendor chart data to match colors
   const vendorChartLabels = App.data.charts.vendor?.data?.labels || [];
   const vendorChartColors = App.data.charts.vendor?.data?.datasets?.[0]?.backgroundColor || [];
   
   // Create a mapping of vendor names to colors from the vendor chart
   const vendorColorMap = {};
   for (let i = 0; i < vendorChartLabels.length; i++) {
     vendorColorMap[vendorChartLabels[i]] = vendorChartColors[i];
   }
   
   try {
     // Add a style element to override the default d3-sankey cursor behavior
     const styleElement = document.createElement('style');
     styleElement.textContent = `
       .node rect {
         cursor: default !important; /* Override default move cursor */
       }
       .node[data-depth="2"] rect {
         cursor: pointer !important; /* Pointer cursor for vendor nodes */
       }
     `;
     document.head.appendChild(styleElement);
     
     // Get container dimensions - get the actual pixel width
     const containerRect = container.getBoundingClientRect();
     const width = containerRect.width - 10; // Subtract a small amount for padding
     const height = containerRect.height - 10;
     
     // Create SVG with explicit dimensions that match the container
     const svg = d3.select(container)
       .append('svg')
       .attr('width', '100%')  // Make SVG fill the container width
       .attr('height', height)
       .attr('viewBox', `0 0 ${width} ${height}`)
       .attr('preserveAspectRatio', 'xMinYMin meet');
     
     // Create Sankey generator that uses the full width
     const sankey = d3.sankey()
       .nodeWidth(15)
       .nodePadding(8)
       .extent([[0, 0], [width, height]])
       .nodeSort((a, b) => b.value - a.value); // Sort by value (largest first)
     
     // Generate layout
     const sankeyData = sankey(data);
     
     // For debugging - add background rectangle to show the full extent
     svg.append('rect')
       .attr('width', width)
       .attr('height', height)
       .attr('fill', 'none')
       .attr('stroke', 'rgba(0,0,0,0.1)')
       .attr('stroke-width', 1);
     
     // Find the rightmost node
     let maxX = 0;
     sankeyData.nodes.forEach(node => {
       maxX = Math.max(maxX, node.x1);
     });
     
     // If the rightmost node is not using the full width, apply scaling
     if (maxX < width - 30) {
       const scaleFactor = (width - 20) / maxX;
       
       // Scale all node positions
       sankeyData.nodes.forEach(node => {
         node.x0 *= scaleFactor;
         node.x1 *= scaleFactor;
       });
     }
     
     // Create color mappings for each node
     const nodeColorMap = new Map();
     
     // Grayscale for agencies and offices
     const agencyGray = '#666666';
     const officeGray = '#999999';
     
     // Default gray for vendors not in top vendors
     const defaultVendorGray = '#cccccc';
     
     // Function to find the best match for a vendor name in the vendor chart labels
     function findBestVendorMatch(nodeName) {
       // Check for direct match first
       if (vendorColorMap[nodeName]) {
         return nodeName;
       }
       
       // Simple normalization - extract company name without details
       const simplifiedName = nodeName.split(' ')[0];
       
       // Look for partial matches in vendor chart labels
       for (const chartVendor in vendorColorMap) {
         if (nodeName.includes(chartVendor) || chartVendor.includes(simplifiedName)) {
           return chartVendor;
         }
       }
       
       // Special cases for common vendor variations
       if (nodeName.includes('MICROSOFT')) return 'MICROSOFT';
       if (nodeName.includes('PALANTIR')) return 'PALANTIR';
       if (nodeName.includes('DELL')) return 'DELL FEDERAL';
       if (nodeName.includes('AMAZON')) return 'AMAZON WEB';
       
       return null;
     }
     
     // Assign colors to nodes
     sankeyData.nodes.forEach(node => {
       if (node.depth === 0) {
         // Agency nodes - dark gray
         nodeColorMap.set(node.index, agencyGray);
       } else if (node.depth === 1) {
         // Office nodes - medium gray
         nodeColorMap.set(node.index, officeGray);
       } else if (node.depth === 2) {
         // Vendor nodes - try to match with vendor chart
         const matchedVendor = findBestVendorMatch(node.name);
         
         if (matchedVendor && vendorColorMap[matchedVendor]) {
           nodeColorMap.set(node.index, vendorColorMap[matchedVendor]);
         } else {
           // For vendors not in top list, use light gray
           nodeColorMap.set(node.index, defaultVendorGray);
         }
       }
     });
     
     // Draw links with colors matching target nodes
     const link = svg.append('g')
       .selectAll('.link')
       .data(sankeyData.links)
       .join('path')
       .attr('class', 'link')
       .attr('d', d3.sankeyLinkHorizontal())
       .attr('stroke-width', d => Math.max(1, d.width))
       .style('stroke', function(d) {
         // Use target node color for the link
         return nodeColorMap.get(d.target.index);
       })
       .style('fill', 'none')
       .style('stroke-opacity', 0.3);
     
     // Add hover effect and tooltip to links
     link.append('title')
       .text(d => `${d.source.name} → ${d.target.name}\n${App.utils.formatCurrency(d.value)}`);
     
     // Draw nodes
     const node = svg.append('g')
       .selectAll('.node')
       .data(sankeyData.nodes)
       .join('g')
       .attr('class', 'node')
       .attr('data-depth', d => d.depth) // Add data-depth attribute for CSS targeting
       .attr('transform', d => `translate(${d.x0},${d.y0})`);
     
     // Add rectangles for nodes with consistent colors
     const rects = node.append('rect')
       .attr('height', d => Math.max(1, d.y1 - d.y0))
       .attr('width', d => d.x1 - d.x0)
       .attr('fill', d => nodeColorMap.get(d.index))
       .attr('stroke', d => {
         const baseColor = nodeColorMap.get(d.index);
         return d3.rgb(baseColor).darker(0.3);
       })
       .style('fill-opacity', 0.85);
     
     // Add click handlers only to vendor node rectangles
     node.filter(d => d.depth === 2) // Only vendor nodes
       .select('rect')
       .style('cursor', 'pointer')
       .on('click', function(event, d) {
         event.stopPropagation(); // Prevent event bubbling
         
         // Call the filter function
         App.handlers.filterByVendorName(d.name);
       });
     
     // Add node labels
     node.append('text')
       .attr('x', d => {
         // Position labels based on node position in diagram
         const relativeX = d.x0 / width;
         if (relativeX < 0.3) return d.x1 - d.x0 + 6; // Left side
         if (relativeX > 0.7) return -6;              // Right side
         return (d.x1 - d.x0) / 2;                    // Middle
       })
       .attr('y', d => (d.y1 - d.y0) / 2)
       .attr('dy', '0.35em')
       .attr('text-anchor', d => {
         const relativeX = d.x0 / width;
         if (relativeX < 0.3) return 'start';
         if (relativeX > 0.7) return 'end';
         return 'middle';
       })
       .text(d => {
         // Truncate node name if too long
         const maxLength = 25;
         return d.name.length > maxLength ? d.name.substring(0, maxLength) + '...' : d.name;
       })
       .style('fill', d => {
         // Use white text for dark backgrounds, black for light backgrounds
         const color = d3.rgb(nodeColorMap.get(d.index));
         return color.l < 0.5 ? '#ffffff' : '#333333';
       })
       .style('font-size', '11px')
       .style('font-weight', '500');
     
     // Add tooltips to vendor nodes
     node.filter(d => d.depth === 2) // Only vendor nodes
       .append('title')
       .text(d => `Click to filter to ${d.name}`);
   } catch (error) {
     App.handleError("rendering Sankey diagram", error);
     container.innerHTML = `<div style="text-align: center; padding: 50px;">Error: ${error.message}</div>`;
   }
 }
};

/**
* Data handling functions
*/
App.handlers = {
 /**
  * Load CSV file
  */
 loadCSVFile: function() {
   var fileInput = document.getElementById('csvFileInput');
   var file = fileInput.files[0];

   if (!file) {
     App.ui.showMessage("Please select a CSV file first.", "error");
     return;
   }

   let fileName = file.name.toLowerCase();
   let isLikelyCsv = false;

   // Check for common CSV patterns, including the iOS-specific one
   if (fileName.endsWith('.csv') || fileName.endsWith('.csv.xls')) {
     isLikelyCsv = true;
   }

   // Fallback check for MIME type if filename isn't conclusive
   if (!isLikelyCsv && (file.type === 'text/csv' || file.type === 'application/vnd.ms-excel' || (file.type === '' && fileName.includes('csv')))) {
     isLikelyCsv = true;
   }

   if (isLikelyCsv) {
     // Show loading indicator
     App.ui.showLoadingIndicator(true, "Loading CSV file...", `Processing ${file.name}`);
     
     App.ui.showMessage("Loading file: " + file.name + ". Please wait...", "info");

     // Comprehensive Reset before loading new data
     App.data.allData = [];
     App.data.filteredData = [];
     App.data.isAutoLoadedData = false; // Reset auto-loaded flag

     const unifiedSearchInput = document.getElementById('unifiedSearch');
     if (unifiedSearchInput) unifiedSearchInput.value = '';

     const dynamicFiltersContainer = document.getElementById('dynamicFiltersContainer');
     if (dynamicFiltersContainer) dynamicFiltersContainer.innerHTML = '';

     const tableBodyIds = ['officeTableBody', 'contractsTableBody'];
     tableBodyIds.forEach(id => {
       const tbody = document.getElementById(id);
       if (tbody) tbody.innerHTML = '<tr><td colspan="100%">Loading data...</td></tr>';
     });

     const totalContractsEl = document.getElementById('totalContracts');
     if (totalContractsEl) totalContractsEl.textContent = '0';
     const totalValueEl = document.getElementById('totalValue');
     if (totalValueEl) totalValueEl.textContent = '$0';
     const activeVendorsEl = document.getElementById('activeVendors');
     if (activeVendorsEl) activeVendorsEl.textContent = '0';

     const sankeyChartArea = document.getElementById('sankeyChart');
     if (sankeyChartArea) {
       sankeyChartArea.innerHTML = '';
     }
     
     App.charts.initCharts();
     
     // Hide data context info
     App.ui.hideDataContextInfo();

     var reader = new FileReader();
     reader.onload = function(e) {
       var csvContent = e.target.result;
       // Update loading indicator
       App.ui.showLoadingIndicator(true, "Parsing CSV data...", `${file.name}`, 30);
       
       App.handlers.parseCSV(csvContent);
       fileInput.value = null; // Clear file input to allow re-selecting same file
       
       // Hide loading indicator
       App.ui.showLoadingIndicator(false);
     };
     reader.onerror = function(e) {
       App.handleError("reading file", e, "Error reading file: " + e.message);
       fileInput.value = null;
       
       // Hide loading indicator with error message
       App.ui.showLoadingIndicator(false);
     };
     reader.readAsText(file); // Always read as text, as CSV is text-based

   } else {
     App.ui.showMessage("Unsupported file type: '" + file.name + "'. Please upload a CSV file from FPDS.gov.", "error");
     fileInput.value = null; // Clear the invalid file selection
   }
 },

 /**
  * Parse CSV data
  */
 parseCSV: function(csvText) {
   try {
     App.ui.showMessage("Parsing CSV data...", "info");
     // Update loading indicator
     App.ui.showLoadingIndicator(true, "Parsing CSV data...", "Analyzing file format", 40);
     
     // Split into lines
     var lines = csvText.split(/\r?\n/);
     
     if (lines.length <= 1) {
       App.ui.showMessage("Could not parse CSV. Check format.", "error");
       App.ui.showLoadingIndicator(false);
       return;
     }
     
     // Parse headers and data
     var headers = App.utils.parseCSVLine(lines[0]);
     
     // Update loading indicator
     App.ui.showLoadingIndicator(true, "Processing data...", `Processing ${lines.length} rows`, 50);
     
     var rawData = [];
     
     // Parse data rows
     for (var i = 1; i < lines.length; i++) {
       if (i % 1000 === 0 || i === lines.length - 1) {
         // Update progress every 1000 rows
         const progress = Math.min(50 + Math.floor((i / lines.length) * 45), 95);
         App.ui.updateLoadingProgress(progress, "Processing data...", `Processing row ${i} of ${lines.length}`);
       }
       
       if (lines[i].trim()) {
         try {
           var values = App.utils.parseCSVLine(lines[i]);
           
           if (values.length >= 5) {
             var row = {};
             for (var j = 0; j < Math.min(headers.length, values.length); j++) {
               if (headers[j]) {
                 row[headers[j]] = values[j] || '';
               }
             }
             rawData.push(row);
           }
         } catch (e) {
           App.handleError("parsing line " + i, e);
         }
       }
     }
     
     // Update loading indicator
     App.ui.showLoadingIndicator(true, "Finalizing data...", "Preparing dashboard", 95);
     
     if (rawData.length > 0) {
       App.handlers.processData(rawData);
     } else {
       App.ui.showMessage("No valid data rows found in the CSV.", "error");
       App.ui.showLoadingIndicator(false);
     }
   } catch (error) {
     App.handleError("parsing CSV", error, "Error parsing CSV: " + error.message);
     App.ui.showLoadingIndicator(false);
   }
 },

 /**
  * Process raw data
  */
 processData: function(rawData) {
   App.ui.showMessage("Processing data...");
   // Final loading indicator update
   App.ui.showLoadingIndicator(true, "Finalizing...", "Preparing visualization", 95);
   
   // Transform data for our dashboard
   App.data.allData = [];
   for (var i = 0; i < rawData.length; i++) {
     var row = rawData[i];
     
     // Extract vendor name
     var vendor = row['Legal Business Name'] || '';
     
     try {
       App.data.allData.push({
         id: row['Contract ID'] || '',
         reference: row['Reference IDV'] || '',
         vendor: vendor,
         parentCompany: row['Ultimate Parent Legal Business Name'] || '',
         agency: row['Contracting Agency'] || '',
         office: row['Contracting Office Name'] || '',
         date: row['Date Signed'] || '',
         value: App.utils.parseMoneyValue(row['Action Obligation ($)']),
         type: row['Award/IDV Type'] || '',
         description: row['PSC Description'] || '',
         location: (row['Entity City'] || '') + ', ' + (row['Entity State'] || ''),
         naics: row['NAICS'] || '',
         naicsDescription: row['NAICS Description'] || '',
       });
     } catch (error) {
       App.handleError("processing row " + i, error);
     }
   }
   
   // Set filtered data to all data initially
   App.data.filteredData = [...App.data.allData];
   
   // Create dynamic dropdowns after data is loaded
   try {
     App.handlers.createDynamicDropdowns();
     App.handlers.setupAutoFiltering();
     App.handlers.addDateSignedFilter();
   } catch (error) {
     App.handleError("setting up filters", error);
   }
   
   // Update the dashboard with filtered data
   App.handlers.updateDashboard();
   
   // Create and update Sankey diagram
   setTimeout(function() {
     App.sankey.createSankeyDiagram();
     
     // Hide loading indicator
     App.ui.showLoadingIndicator(false);
     
     App.ui.showMessage("Successfully loaded " + App.data.allData.length + " contracts. Ready for analysis.", "success");
     
     // Detect date range in data
     App.handlers.detectDateRangeFromData();
   }, 500);
 },

 /**
  * Update dashboard
  */
 updateDashboard: function() {
   App.handlers.updateStats();
   App.charts.updateAllCharts();
   App.handlers.updateOfficeTable();
   App.handlers.updateContractsTable();
   App.handlers.initSortableTables();
 },

 /**
  * Update dashboard statistics
  */
 updateStats: function() {
   var totalContracts = App.data.filteredData.length;
   var totalValue = App.data.filteredData.reduce((sum, item) => sum + item.value, 0);
   var uniqueVendors = new Set(App.data.filteredData.map(item => item.vendor));
   
   var vendorCount = uniqueVendors.size;
   
   document.getElementById('totalContracts').textContent = totalContracts.toLocaleString();
   document.getElementById('totalValue').textContent = App.utils.formatCurrency(totalValue);
   document.getElementById('activeVendors').textContent = vendorCount.toLocaleString();
 },

 /**
  * Initialize sortable tables
  */
 initSortableTables: function() {
   // Find all sortable tables
   var tables = document.querySelectorAll('table.sortable');
   
   // Add click event listeners to all sortable table headers
   tables.forEach(function(table) {
     var headers = table.querySelectorAll('th');
     headers.forEach(function(header, index) {
       App.utils.addEventListenerSafe(header, 'click', function() {
         App.handlers.sortTable(table, index, header.getAttribute('data-sort'));
       });
     });
   });
 },

 /**
  * Sort table by column
  */
 sortTable: function(table, columnIndex, dataType) {
   var tbody = table.querySelector('tbody');
   var rows = Array.from(tbody.querySelectorAll('tr'));
   var headers = table.querySelectorAll('th');
   
   // Determine sort direction
   var sortDirection = 'asc';
   if (headers[columnIndex].classList.contains('sort-asc')) {
     sortDirection = 'desc';
   }
   
   // Reset all headers
   headers.forEach(function(header) {
     header.classList.remove('sort-asc', 'sort-desc');
   });
   
   // Add appropriate class to current header
   headers[columnIndex].classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
   
   // Sort the rows
   rows.sort(function(rowA, rowB) {
     var cellA = rowA.querySelectorAll('td')[columnIndex].textContent.trim();
     var cellB = rowB.querySelectorAll('td')[columnIndex].textContent.trim();
     
     var comparison = 0;
     
     switch (dataType) {
       case 'number':
         // Extract numbers from strings like "$1.2M" or "15%"
         var numA = App.handlers.parseNumberFromString(cellA);
         var numB = App.handlers.parseNumberFromString(cellB);
         comparison = numA - numB;
         break;
         
       case 'date':
         // Parse dates
         var dateA = App.utils.parseDate(cellA) || new Date(0);
         var dateB = App.utils.parseDate(cellB) || new Date(0);
         comparison = dateA - dateB;
         break;
         
       case 'string':
       default:
         // Simple string comparison
         comparison = cellA.localeCompare(cellB);
         break;
     }
     
     // Reverse if descending
     return sortDirection === 'asc' ? comparison : -comparison;
   });
   
   // Re-append rows in new order
   rows.forEach(function(row) {
     tbody.appendChild(row);
   });
 },

 /**
  * Parse number from string
  */
 parseNumberFromString: function(str) {
   // Handle currency values like "$1.2M", "$500K"
   if (str.includes('$')) {
     str = str.replace('$', '');
     
     if (str.includes('B')) {
       return parseFloat(str.replace('B', '')) * 1000000000;
     } else if (str.includes('M')) {
       return parseFloat(str.replace('M', '')) * 1000000;
     } else if (str.includes('K')) {
       return parseFloat(str.replace('K', '')) * 1000;
     }
   }
   
   // Handle percentage values
   if (str.includes('%')) {
     return parseFloat(str.replace('%', ''));
   }
   
   // Try to parse any other number
   var num = parseFloat(str.replace(/,/g, ''));
   return isNaN(num) ? 0 : num;
 },

 /**
  * Update office table
  */
 updateOfficeTable: function() {
   // Group by office
   var officeAnalysis = {};
   
   for (var i = 0; i < App.data.filteredData.length; i++) {
     var contract = App.data.filteredData[i];
     var office = contract.office || 'Unknown';
     var agency = contract.agency || '';
     
     if (!officeAnalysis[office]) {
       officeAnalysis[office] = {
         value: 0,
         count: 0,
         largest: 0,
         largestContract: null,
         agency: agency
       };
     }
     
     officeAnalysis[office].value += contract.value;
     officeAnalysis[office].count++;
     
     if (contract.value > officeAnalysis[office].largest) {
       officeAnalysis[office].largest = contract.value;
       officeAnalysis[office].largestContract = contract;
     }
   }
   
   // Convert to array and sort
   var officeArray = [];
   for (var office in officeAnalysis) {
     officeArray.push({
       name: office,
       value: officeAnalysis[office].value,
       count: officeAnalysis[office].count,
       largest: officeAnalysis[office].largest,
       largestContract: officeAnalysis[office].largestContract,
       agency: officeAnalysis[office].agency
     });
   }
   
   officeArray.sort(function(a, b) {
     return b.value - a.value;
   });
   
   // Get top 15
   var topOffices = officeArray.slice(0, 15);
   
   // Update table
   var tbody = document.getElementById('officeTableBody');
   if (!tbody) return;
   
   tbody.innerHTML = '';
   
   for (var i = 0; i < topOffices.length; i++) {
     var office = topOffices[i];
     var row = document.createElement('tr');
     
     // Create FPDS link for largest contract
     var fpdsLink = '';
     if (office.largestContract && office.largestContract.id) {
       fpdsLink = App.handlers.buildFpdsLink(office.largestContract);
     } else {
       fpdsLink = '<span class="badge badge-inactive">No ID</span>';
     }
     
     // Get the vendor name of the largest contract
     var topContractVendor = office.largestContract ? 
       (office.largestContract.vendor || 'Unknown vendor') : 
       'No contract data';
     
     // Truncate vendor name if too long
     if (topContractVendor.length > 40) {
       topContractVendor = topContractVendor.substring(0, 37) + '...';
     }
     
     row.innerHTML = 
       '<td>' + office.agency + '</td>' +
       '<td>' + office.name + '</td>' +
       '<td>' + App.utils.formatCurrency(office.value) + '</td>' +
       '<td>' + office.count + '</td>' +
       '<td title="' + topContractVendor + '">' + topContractVendor + '</td>' +
       '<td>' + App.utils.formatCurrency(office.largest) + '</td>' +
       '<td>' + fpdsLink + '</td>';
     
     tbody.appendChild(row);
   }
 },

 /**
  * Build FPDS.gov link
  */
 buildFpdsLink: function(contract) {
   // Check if we have the minimum required data
   if (!contract.id) {
     return '<span class="badge badge-inactive">No ID</span>';
   }
   
   try {
     // Use the public ezsearch interface
     const PIID = contract.id || '';
     
     // Build search URL - this uses the public search interface which doesn't require a session
     const searchUrl = "https://www.fpds.gov/ezsearch/search.do?indexName=awardfull&templateName=1.5.3&s=FPDS&q=" + encodeURIComponent(PIID) + "&sortBy=SIGNED_DATE&desc=Y";
     
     return '<a href="' + searchUrl + '" target="_blank" class="fpds-link" title="View contract details in FPDS.gov"><i class="fas fa-external-link-alt"></i> View in FPDS</a>';
   } catch (error) {
     App.handleError("building FPDS link", error);
     return '<span class="badge badge-inactive">Link Error</span>';
   }
 },

 /**
  * Update contracts table
  */
 updateContractsTable: function() {
   // Sort by date (newest first)
   var sortedContracts = [...App.data.filteredData];
   
   sortedContracts.sort(function(a, b) {
     var dateA = App.utils.parseDate(a.date) || new Date(0);
     var dateB = App.utils.parseDate(b.date) || new Date(0);
     return dateB - dateA;
   });
   
   // Get most recent contracts
   var recentContracts = sortedContracts.slice(0, 20);
   
   // Update table
   var tbody = document.getElementById('contractsTableBody');
   if (!tbody) return;
   
   tbody.innerHTML = '';
   
   for (var i = 0; i < recentContracts.length; i++) {
     var contract = recentContracts[i];
     var row = document.createElement('tr');
     
     var statusText = contract.value > 0 ? 'Funded' : 'Zero Value';
     
     // Generate FPDS hyperlink
     var fpdsLink = contract.id ? App.handlers.buildFpdsLink(contract) : 'N/A';
     
     var parentCompanyHtml = '';
     if (contract.parentCompany && contract.parentCompany !== contract.vendor) {
       parentCompanyHtml = '<div style="font-size: 0.8em; color: #666;">Parent: ' + contract.parentCompany + '</div>';
     }
     
     var officeHtml = '';
     if (contract.office) {
       officeHtml = '<div style="font-size: 0.8em; color: #666;">' + contract.office + '</div>';
     }
     
     var idHtml = '';
     if (contract.id) {
       idHtml = '<div style="font-size: 0.8em; color: #666;">ID: ' + contract.id + ' | ' + contract.reference + '</div>';
     }
     
     row.innerHTML = 
       '<td>' + App.utils.formatDate(contract.date) + '</td>' +
       '<td>' + contract.vendor + parentCompanyHtml + '</td>' +
       '<td>' + contract.agency + officeHtml + '</td>' +
       '<td>' + contract.description + idHtml + '</td>' +
       '<td class="amount">' + App.utils.formatCurrency(contract.value) + '</td>' +
       '<td>' + fpdsLink + '</td>';
     
     tbody.appendChild(row);
   }
 },

 /**
  * Create dynamic dropdowns
  */
 createDynamicDropdowns: function() {
   if (App.data.allData.length === 0) {
     return; // Don't create dropdowns if no data is loaded
   }

   var dynamicFiltersContainer = document.getElementById('dynamicFiltersContainer');
   if (dynamicFiltersContainer) {
     dynamicFiltersContainer.innerHTML = ''; // Clear existing dynamic filters
   } else {
     return;
   }

   // Fields for dropdowns and their display labels
   var dropdownFields = [
     { id: 'agencyFilter', field: 'agency', label: 'Agency' },
     { id: 'officeFilter', field: 'office', label: 'Office' },
     { id: 'vendorFilter', field: 'vendor', label: 'Vendor' },
     { id: 'naicsFilter', field: 'naics', label: 'NAICS Code' }
   ];

   dropdownFields.forEach(function(dropdownField) {
     var formGroup = document.createElement('div');
     formGroup.className = 'form-group';

     var select = document.createElement('select');
     select.id = dropdownField.id;
     select.className = 'form-control';
     select.style.width = '100%';

     // Add a selectable "All [Category]" option as the first item
     var allOption = document.createElement('option');
     allOption.value = '';

     // Make the text clearly indicate it's for showing all items
     let allOptionText = 'All ' + dropdownField.label;
     if (dropdownField.label === "NAICS Code") {
       allOptionText = "All NAICS Codes";
     } else if (dropdownField.label.endsWith('y')) {
       allOptionText = "All " + dropdownField.label.slice(0, -1) + "ies"; // e.g. Agency -> All Agencies
     } else if (!dropdownField.label.endsWith('s')) {
       allOptionText = "All " + dropdownField.label + "s"; // e.g. Vendor -> All Vendors
     }
     allOption.textContent = allOptionText;
     select.appendChild(allOption);

     // Get unique values for this field and their totals
     var uniqueValues = {};
     var valuesByTotal = {};
     
     // For NAICS codes, also track the description
     var naicsDescriptions = {};

     for (var i = 0; i < App.data.allData.length; i++) {
       var value = App.data.allData[i][dropdownField.field];
       if (value) {
         if (!uniqueValues[value]) {
           uniqueValues[value] = 0;
           valuesByTotal[value] = 0;
           
           // Store NAICS description if this is the NAICS filter
           if (dropdownField.id === 'naicsFilter' && App.data.allData[i].naicsDescription) {
             naicsDescriptions[value] = App.data.allData[i].naicsDescription;
           }
         }
         uniqueValues[value]++;
         valuesByTotal[value] += App.data.allData[i].value || 0;
       }
     }

     var valueArray = [];
     for (var value in valuesByTotal) {
       valueArray.push({
         value: value,
         count: uniqueValues[value],
         total: valuesByTotal[value],
         description: naicsDescriptions[value] || ''
       });
     }

     valueArray.sort(function(a, b) {
       return b.total - a.total;
     });

     var topValues = valueArray.slice(0, 50); // Limit options for performance

     for (var j = 0; j < topValues.length; j++) {
       var option = document.createElement('option');
       option.value = topValues[j].value;

       var displayValue = topValues[j].value;
       if (displayValue && displayValue.length > 30) {
         displayValue = displayValue.substring(0, 27) + '...';
       }
       
       var formattedTotal = App.utils.formatCurrency(topValues[j].total);
       
       // Special handling for NAICS codes to include a truncated description
       if (dropdownField.id === 'naicsFilter' && topValues[j].description) {
         // Truncate description if too long
         var description = topValues[j].description;
         if (description.length > 40) {
           description = description.substring(0, 37) + '...';
         }
         
         // Format: "541511 - Web Development (42 | $1.2M)"
         option.textContent = `${displayValue} - ${description} (${topValues[j].count} | ${formattedTotal})`;
       } else {
         // Standard format for other filters: "Value (42 | $1.2M)"
         option.textContent = displayValue + ' (' + topValues[j].count + ' | ' + formattedTotal + ')';
       }
       
       select.appendChild(option);
     }

     App.utils.addEventListenerSafe(select, 'change', App.handlers.applyAllFilters);

     formGroup.appendChild(select);
     dynamicFiltersContainer.appendChild(formGroup);
   });
 },

 /**
  * Set up auto-filtering
  */
 setupAutoFiltering: function() {
   // Set up event listener for unified search input
   var unifiedSearch = document.getElementById('unifiedSearch');
   if (unifiedSearch) {
     App.utils.addEventListenerSafe(unifiedSearch, 'input', function() {
       // Small delay to avoid filtering on every keystroke
       clearTimeout(unifiedSearch.timer);
       unifiedSearch.timer = setTimeout(function() {
         App.handlers.applyAllFilters();
       }, 300); // 300ms delay after typing stops
     });
   }
   
   // Set up event listeners for dynamic dropdowns
   var dropdownIds = ['naicsFilter', 'agencyFilter', 'officeFilter', 'vendorFilter'];
   dropdownIds.forEach(function(id) {
     var dropdown = document.getElementById(id);
     if (dropdown) {
       App.utils.addEventListenerSafe(dropdown, 'change', function() {
         App.handlers.applyAllFilters();
       });
     }
   });
 },

 /**
  * Add date signed filter
  */
 addDateSignedFilter: function() {
   // Get the dynamic filters container
   const filtersContainer = document.getElementById('dynamicFiltersContainer');
   if (!filtersContainer) {
     return;
   }

   // Create the month/year filter group
   const dateFilterGroup = document.createElement('div');
   dateFilterGroup.className = 'form-group';
   dateFilterGroup.id = 'dateSignedFilterGroup';

   // Create month/year selector with labels
   dateFilterGroup.innerHTML = `
     <div style="margin-bottom: 0.25rem;">
     </div>
     <div style="display: flex; gap: 0.5rem;">
       <div style="flex: 1;">
         <select id="monthFilter" class="form-control">
           <option value="">All Months</option>
           <option value="Jan">January</option>
           <option value="Feb">February</option>
           <option value="Mar">March</option>
           <option value="Apr">April</option>
           <option value="May">May</option>
           <option value="Jun">June</option>
           <option value="Jul">July</option>
           <option value="Aug">August</option>
           <option value="Sep">September</option>
           <option value="Oct">October</option>
           <option value="Nov">November</option>
           <option value="Dec">December</option>
         </select>
       </div>
       <div style="flex: 1;">
         <select id="yearFilter" class="form-control">
           <option value="">All Years</option>
         </select>
       </div>
     </div>
   `;
   filtersContainer.appendChild(dateFilterGroup);

   // Initialize year options
   App.handlers.populateYearOptions();

   // Add event listeners
   App.utils.addEventListenerSafe(document.getElementById('monthFilter'), 'change', App.handlers.applyDateFilter);
   App.utils.addEventListenerSafe(document.getElementById('yearFilter'), 'change', App.handlers.applyDateFilter);
 },

 /**
  * Populate year options based on the data
  */
 populateYearOptions: function() {
   // Get year filter dropdown
   const yearFilter = document.getElementById('yearFilter');
   if (!yearFilter) return;

   // Get unique years from the data
   const uniqueYears = new Set();
   
   // Function to extract year from DD-MMM-YY format
   function extractYear(dateStr) {
     if (!dateStr) return null;
     
     const match = dateStr.match(/\d+-\w+-(\d+)/);
     if (match && match[1]) {
       const year = parseInt(match[1]);
       // Convert 2-digit year to 4-digit
       return year < 50 ? 2000 + year : 1900 + year;
     }
     return null;
   }

   // Collect unique years from data
   App.data.allData.forEach(item => {
     const year = extractYear(item.date);
     if (year) {
       uniqueYears.add(year);
     }
   });

   // Convert to array and sort in descending order (newest first)
   const years = Array.from(uniqueYears).sort((a, b) => b - a);

   // Add options to the dropdown
   years.forEach(year => {
     const option = document.createElement('option');
     option.value = year;
     option.textContent = year;
     yearFilter.appendChild(option);
   });
 },

 /**
  * Apply date filter
  */
 applyDateFilter: function() {
   const monthFilter = document.getElementById('monthFilter').value;
   const yearFilter = document.getElementById('yearFilter').value;
   
   // If no filters selected, just use the standard filtering
   if (!monthFilter && !yearFilter) {
     App.handlers.applyAllFilters();
     return;
   }
   
   // Start with all data
   let dateFilteredData = [...App.data.allData];
   
   // Apply other filters first
   dateFilteredData = App.handlers.applyOtherFilters(dateFilteredData);
   
   // Then apply date filters
   if (monthFilter || yearFilter) {
     dateFilteredData = dateFilteredData.filter(item => {
       // Parse the date
       if (!item.date) return false;
       
       // Extract date components using regex
       const dateMatch = item.date.match(/(\d+)-(\w+)-(\d+)/);
       if (!dateMatch) return false;
       
       const day = dateMatch[1];
       const month = dateMatch[2];
       const yearDigits = dateMatch[3];
       
       // Convert 2-digit year to 4-digit
       const fullYear = parseInt(yearDigits) < 50 ? "20" + yearDigits : "19" + yearDigits;
       
       // Apply month filter if specified
       if (monthFilter && month !== monthFilter) {
         return false;
       }
       
       // Apply year filter if specified (ensure string comparison)
       if (yearFilter && fullYear !== yearFilter.toString()) {
         return false;
       }
       
       return true;
     });
   }
   
   // Update filtered data
   App.data.filteredData = dateFilteredData;
   
   // Generate filter message
   let filterMessage = `Showing ${App.data.filteredData.length.toLocaleString()} contracts`;
   let filterDetails = {};
   
   if (monthFilter) {
     // Convert short month to full name
     const monthNames = {
       'Jan': 'January', 'Feb': 'February', 'Mar': 'March', 'Apr': 'April',
       'May': 'May', 'Jun': 'June', 'Jul': 'July', 'Aug': 'August',
       'Sep': 'September', 'Oct': 'October', 'Nov': 'November', 'Dec': 'December'
     };
     filterDetails["Month"] = monthNames[monthFilter] || monthFilter;
   }
   
   if (yearFilter) {
     filterDetails["Year"] = yearFilter;
   }
   
   // Calculate totals
   const totalValue = App.data.filteredData.reduce((sum, item) => sum + item.value, 0);
   filterDetails["Total Value"] = App.utils.formatCurrency(totalValue);
   
   // Update status message
   App.ui.showMessage(filterMessage, "info", filterDetails);
   
   // Update dashboard
   App.handlers.updateDashboard();
   
   // Update Sankey diagram if it exists
   if (document.getElementById('sankeyChart')) {
     App.sankey.updateWithFilteredData();
   }
 },

 /**
  * Apply other filters except date
  */
 applyOtherFilters: function(data) {
   let result = [...data];
   
   // Apply unified search if there's a search term
   const searchTerm = document.getElementById('unifiedSearch').value.toLowerCase().trim();
   if (searchTerm) {
     result = result.filter(function(item) {
       // Search across all string properties
       for (var key in item) {
         if (typeof item[key] === 'string' && 
             item[key].toLowerCase().indexOf(searchTerm) !== -1) {
           return true;
         }
       }
       return false;
     });
   }
   
   // Apply dropdown filters
   const dropdowns = {
     'naicsFilter': 'naics',
     'agencyFilter': 'agency',
     'officeFilter': 'office',
     'vendorFilter': 'vendor'
   };
   
   for (const id in dropdowns) {
     const dropdown = document.getElementById(id);
     if (dropdown && dropdown.value) {
       const field = dropdowns[id];
       result = result.filter(item => item[field] === dropdown.value);
     }
   }
   
   return result;
 },

 /**
  * Apply all filters
  */
 applyAllFilters: function() {
   // Start with all data
   App.data.filteredData = [...App.data.allData];
   
   // Track applied filters for status message
   var appliedFilters = {};
   
   // Apply unified search if there's a search term
   var searchTerm = document.getElementById('unifiedSearch').value.toLowerCase().trim();
   if (searchTerm) {
     App.data.filteredData = App.data.filteredData.filter(function(item) {
       // Search across all string properties
       for (var key in item) {
         if (typeof item[key] === 'string' && 
             item[key].toLowerCase().indexOf(searchTerm) !== -1) {
           return true;
         }
       }
       return false;
     });
     
     appliedFilters["Search"] = searchTerm;
   }
   
   // Apply dropdown filters
   var dropdowns = {
     'naicsFilter': 'NAICS',
     'agencyFilter': 'Agency',
     'officeFilter': 'Office',
     'vendorFilter': 'Vendor'
   };
   
   for (var id in dropdowns) {
     var dropdown = document.getElementById(id);
     if (dropdown && dropdown.value) {
       var field = id.replace('Filter', '').toLowerCase();
       var label = dropdowns[id];
       
       App.data.filteredData = App.data.filteredData.filter(function(item) {
         return item[field] === dropdown.value;
       });
       
       appliedFilters[label] = dropdown.value;
       
       // For NAICS filter, also add the description
       if (id === 'naicsFilter' && App.data.filteredData.length > 0) {
         // Find the first item with this NAICS code to get its description
         for (let i = 0; i < App.data.filteredData.length; i++) {
           if (App.data.filteredData[i].naicsDescription) {
             appliedFilters["NAICS Description"] = App.data.filteredData[i].naicsDescription;
             break;
           }
         }
       }
     }
   }
   
   // Apply date filters
   const monthFilter = document.getElementById('monthFilter');
   const yearFilter = document.getElementById('yearFilter');
   
   if (monthFilter && monthFilter.value) {
     // Convert short month to full name
     const monthNames = {
       'Jan': 'January', 'Feb': 'February', 'Mar': 'March', 'Apr': 'April',
       'May': 'May', 'Jun': 'June', 'Jul': 'July', 'Aug': 'August',
       'Sep': 'September', 'Oct': 'October', 'Nov': 'November', 'Dec': 'December'
     };
     appliedFilters["Month"] = monthNames[monthFilter.value] || monthFilter.value;
     
     // Apply filter
     App.data.filteredData = App.data.filteredData.filter(item => {
       if (!item.date) return false;
       const dateMatch = item.date.match(/\d+-(\w+)-\d+/);
       return dateMatch && dateMatch[1] === monthFilter.value;
     });
   }
   
   if (yearFilter && yearFilter.value) {
     appliedFilters["Year"] = yearFilter.value;
     
     // Apply filter
     App.data.filteredData = App.data.filteredData.filter(item => {
       if (!item.date) return false;
       const dateMatch = item.date.match(/\d+-\w+-(\d+)/);
       if (!dateMatch) return false;
       
       const yearDigits = dateMatch[1];
       const fullYear = parseInt(yearDigits) < 50 ? "20" + yearDigits : "19" + yearDigits;
       return fullYear === yearFilter.value;
     });
   }
   
   // Update the dashboard with filtered data
   App.handlers.updateDashboard();
   
   // Generate natural language message
   var totalContracts = App.data.filteredData.length;
   var totalValue = App.data.filteredData.reduce((sum, item) => sum + item.value, 0);
   
   // Create primary message based on results
   var primaryMessage = "";
   if (Object.keys(appliedFilters).length > 0) {
     primaryMessage = `Showing ${totalContracts.toLocaleString()} filtered contracts with a total value of ${App.utils.formatCurrency(totalValue)}`;
   } else {
     primaryMessage = `Showing all ${totalContracts.toLocaleString()} contracts with a total value of ${App.utils.formatCurrency(totalValue)}`;
   }
   
   // Add total value to filters for display
   appliedFilters["Total Value"] = App.utils.formatCurrency(totalValue);
   
   App.ui.showMessage(primaryMessage, 'info', appliedFilters);
   
   if (document.getElementById('sankeyChart')) {
     App.sankey.updateWithFilteredData();
   }
   
   // Sync with mobile search input
   const mobileSearch = document.getElementById('mobileSearchInput');
   if (mobileSearch && searchTerm) {
     mobileSearch.value = searchTerm;
   }
 },

 /**
  * Reset all filters
  */
 resetAllFilters: function() {
   // Reset the global search input
   document.getElementById('unifiedSearch').value = '';
   
   // Reset all dropdown filters
   var filterSelects = document.querySelectorAll('#dynamicFiltersContainer select');
   filterSelects.forEach(function(select) {
     select.selectedIndex = 0;
   });
   
   // Reset date filters
   const monthFilter = document.getElementById('monthFilter');
   const yearFilter = document.getElementById('yearFilter');
   if (monthFilter) monthFilter.selectedIndex = 0;
   if (yearFilter) yearFilter.selectedIndex = 0;
   
   // Reset filtered data to all data
   App.data.filteredData = [...App.data.allData];
   
   // Calculate totals
   var totalContracts = App.data.filteredData.length;
   var totalValue = App.data.filteredData.reduce((sum, item) => sum + item.value, 0);
   
   // Update the status message
   var primaryMessage = `Showing all ${totalContracts.toLocaleString()} contracts`;
   var filters = {
     "Total Value": App.utils.formatCurrency(totalValue)
   };
   
   App.ui.showMessage(primaryMessage, "info", filters);
   
   // Update the dashboard
   App.handlers.updateDashboard();
   
   // Update Sankey diagram with all data
   if (document.getElementById('sankeyChart')) {
     App.sankey.updateWithFilteredData();
   }
   
   // Reset mobile search
   const mobileSearch = document.getElementById('mobileSearchInput');
   if (mobileSearch) {
     mobileSearch.value = '';
   }
 },

 /**
  * Filter by vendor name
  */
 filterByVendorName: function(vendorName) {
   // Start with all data
   App.data.filteredData = [...App.data.allData];
   
   // Convert the vendor name to uppercase for case-insensitive comparison
   const nameUpper = vendorName.toUpperCase();
   
   // Filter to include only this vendor
   App.data.filteredData = App.data.filteredData.filter(function(item) {
     // Look for the vendor name in the item's vendor field
     return item.vendor && 
            (item.vendor.toUpperCase().includes(nameUpper) || 
             nameUpper.includes(item.vendor.toUpperCase().split(' ')[0]));
   });
   
   // Check if we have any data after filtering
   if (App.data.filteredData.length === 0) {
     App.ui.showMessage(`No data found for vendor: ${vendorName}`, "error");
     // Reset to all data if no matches
     App.data.filteredData = [...App.data.allData];
     return;
   }
   
   // Calculate total contract value and counts
   var totalValue = App.data.filteredData.reduce((sum, item) => sum + item.value, 0);
   var totalContracts = App.data.filteredData.length;
   var avgContractValue = totalValue / totalContracts;
   
   // Update with natural language messaging
   var primaryMessage = `Showing ${totalContracts.toLocaleString()} contracts for ${vendorName}`;
   var filters = {
     "Vendor": vendorName,
     "Total Value": App.utils.formatCurrency(totalValue),
     "Avg Contract": App.utils.formatCurrency(avgContractValue)
   };
   
   App.ui.showMessage(primaryMessage, "success", filters);
   
   // Update the dashboard with filtered data
   App.handlers.updateDashboard();
   
   // Update Sankey diagram with filtered data
   if (document.getElementById('sankeyChart')) {
     App.sankey.updateWithFilteredData();
   }
 },

 /**
  * Handle mobile reset
  */
 handleMobileReset: function() {
   // 1. Clear search inputs
   const unifiedSearch = document.getElementById('unifiedSearch');
   const mobileSearch = document.getElementById('mobileSearchInput');
   
   if (unifiedSearch) unifiedSearch.value = '';
   if (mobileSearch) mobileSearch.value = '';
   
   // 2. Reset all filters by calling the existing resetAllFilters function
   App.handlers.resetAllFilters();
   
   // 3. Show a confirmation message
   App.ui.showMessage("All filters and search terms have been cleared.", "success");
   
   // 4. Close any open modals/overlays
   const searchBar = document.getElementById('mobileSearchBar');
   const filterModal = document.getElementById('mobileFilterModal');
   
   if (searchBar) searchBar.classList.remove('active');
   if (filterModal) filterModal.classList.remove('active');
   App.utils.handleModal('mobileArchivesModal', 'hide');
   
   // 5. Set dashboard button as active
   const bottomBar = document.getElementById('mobileBottomBar');
   if (bottomBar) {
     const buttons = bottomBar.querySelectorAll('.nav-button');
     buttons.forEach(btn => btn.classList.remove('active'));
     
     const dashboardBtn = document.getElementById('dashboardBtn');
     if (dashboardBtn) dashboardBtn.classList.add('active');
   }
 },

 /**
  * Detect date range from data
  */
 detectDateRangeFromData: function() {
   if (!App.data.allData || App.data.allData.length === 0) {
     return;
   }
   
   let earliestDate = new Date('9999-12-31');
   let latestDate = new Date('1970-01-01');
   
   // Loop through data to find min and max dates
   let datesFound = 0;
   
   App.data.allData.forEach(item => {
     if (item.date) {
       const contractDate = App.utils.parseDate(item.date);
       if (contractDate) {
         datesFound++;
         
         if (contractDate < earliestDate) earliestDate = contractDate;
         if (contractDate > latestDate) latestDate = contractDate;
       }
     }
   });
   
   // Ensure dates are valid
   if (earliestDate > latestDate) {
     // Default to current month
     const today = new Date();
     earliestDate = new Date(today.getFullYear(), today.getMonth(), 1);
     latestDate = today;
   }
   
   // Store the detected date range globally
   App.data.currentDataPeriod = {
     startDate: earliestDate,
     endDate: latestDate,
     lastUpdated: new Date() // Today's date
   };
   
   // Create the period description for use in status messages
   const month = App.data.currentDataPeriod.startDate.toLocaleString('default', { month: 'long' });
   const year = App.data.currentDataPeriod.startDate.getFullYear();
   App.data.periodDescription = `for ${month} ${year}`;
   
   // Show data context info since this is auto-loaded data
   if (App.data.isAutoLoadedData) {
     App.ui.showDataContextInfo();
   } else {
     App.ui.hideDataContextInfo();
   }
   
   // Update the data context information and status message
   App.ui.updateDataContext();
   App.handlers.updateStatusWithPeriodInfo();
 },

 /**
  * Update status with period information
  */
 updateStatusWithPeriodInfo: function() {
   // Collect all active filters
   const filters = App.handlers.collectActiveFilters();
   
   // Show enhanced message
   App.ui.showMessage("", "info", filters);
 },

 /**
  * Collect active filters
  */
 collectActiveFilters: function() {
   const filters = {};
   
   // Check for search term
   const searchInput = document.getElementById('unifiedSearch');
   if (searchInput && searchInput.value.trim()) {
     filters["Search"] = searchInput.value.trim();
   }
   
   // Check for date filters
   const monthFilter = document.getElementById('monthFilter');
   const yearFilter = document.getElementById('yearFilter');
   
   if (monthFilter && monthFilter.value) {
     // Convert short month to full name
     const monthNames = {
       'Jan': 'January', 'Feb': 'February', 'Mar': 'March', 'Apr': 'April',
       'May': 'May', 'Jun': 'June', 'Jul': 'July', 'Aug': 'August',
       'Sep': 'September', 'Oct': 'October', 'Nov': 'November', 'Dec': 'December'
     };
     filters["Month"] = monthNames[monthFilter.value] || monthFilter.value;
   }
   
   if (yearFilter && yearFilter.value) {
     filters["Year"] = yearFilter.value;
   }
   
   // Check for dropdown filters
   const dropdowns = {
     'naicsFilter': 'NAICS',
     'agencyFilter': 'Agency',
     'officeFilter': 'Office',
     'vendorFilter': 'Vendor'
   };
   
   for (const id in dropdowns) {
     const dropdown = document.getElementById(id);
     if (dropdown && dropdown.value) {
       filters[dropdowns[id]] = dropdown.value;
       
       // For NAICS filter, also add the description
       if (id === 'naicsFilter' && App.data.filteredData && App.data.filteredData.length > 0) {
         // Find the first item with this NAICS code to get its description
         for (let i = 0; i < App.data.filteredData.length; i++) {
           if (App.data.filteredData[i].naics === dropdown.value && 
               App.data.filteredData[i].naicsDescription) {
             filters["NAICS Description"] = App.data.filteredData[i].naicsDescription;
             break;
           }
         }
       }
     }
   }
   
   // Calculate totals if filtered data is available
   if (App.data.filteredData && App.data.filteredData.length > 0) {
     const totalValue = App.data.filteredData.reduce((sum, item) => sum + item.value, 0);
     filters["Total Value"] = App.utils.formatCurrency(totalValue);
   }
   
   return filters;
 }
};

/**
* Data loading functions
*/
App.data.loadCurrentMonthData = function() {
 // Your actual S3 URL
 const dataUrl = "https://subhoodata.s3.us-east-1.amazonaws.com/data/daily.csv";
 
 // Show loading message
 App.ui.showMessage("", "info", {
   "Status": "Loading current month award data..."
 });
 
 // Initialize charts first if they don't exist
 if (!App.data.charts || !App.data.charts.monthly) {
   // Check if dashboard grid exists
   if (!document.querySelector('.dashboard-grid')) {
     App.charts.setupDashboardGrid();
   }
   // Initialize charts
   App.charts.initCharts();
 }
 
 // Fetch the CSV
 fetch(dataUrl)
   .then(response => {
     if (!response.ok) {
       throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
     }
     return response.text();
   })
   .then(csvText => {
     // Give charts a moment to initialize
     setTimeout(() => {
       // Set flag that this is auto-loaded data
       App.data.isAutoLoadedData = true;
       
       // Parse and load the CSV using your existing function
       App.handlers.parseCSV(csvText);
       
       // After loading, detect the date range in the loaded data
       App.handlers.detectDateRangeFromData();
       
       // Update UI to show current month is active
       App.ui.updateArchiveMonthsUI(true);
       
       // Mark current month as active
       App.data.currentMonthActive = true;
     }, 500);
   })
   .catch(error => {
     App.handleError("loading current month data", error, "Failed to load current month award data. Please try again later.");
   });
};

App.data.loadArchivedMonthData = function(archiveMonth) {
 // Show loading message
 App.ui.showMessage("", "info", {
   "Status": `Loading ${archiveMonth.month} ${archiveMonth.year} award data...`
 });
 
 // Show loading indicator if available
 App.ui.showLoadingIndicator(true, `Loading ${archiveMonth.month} ${archiveMonth.year} data...`, "Fetching archived data");
 
 // Initialize charts if needed
 if (!App.data.charts || !App.data.charts.monthly) {
   // Check if dashboard grid exists
   if (!document.querySelector('.dashboard-grid')) {
     App.charts.setupDashboardGrid();
   }
   // Initialize charts
   App.charts.initCharts();
 }
 
 // Fetch the CSV from the archive URL
 fetch(archiveMonth.url)
   .then(response => {
     if (!response.ok) {
       throw new Error(`Failed to fetch archive data: ${response.status} ${response.statusText}`);
     }
     return response.text();
   })
   .then(csvText => {
     // Give charts a moment to initialize
     setTimeout(() => {
       // Set flag that this is archive data
       App.data.isAutoLoadedData = true;
       
       // Parse and load the CSV using your existing function
       App.handlers.parseCSV(csvText);
       
       // Set the date period manually since this is an archive
       App.data.currentDataPeriod = {
         startDate: new Date(`${archiveMonth.month} 1, ${archiveMonth.year}`),
         endDate: App.utils.getLastDayOfMonth(archiveMonth.month, archiveMonth.year),
         lastUpdated: new Date() // Today's date
       };
       
       // Update period description
       App.data.periodDescription = `for ${archiveMonth.month} ${archiveMonth.year}`;
       
       // Keep the context info and archive months visible
       const dataContextInfo = document.getElementById('dataContextInfo');
       if (dataContextInfo) {
         dataContextInfo.style.display = 'flex';
       }
       
       const archiveMonthsContainer = document.getElementById('archiveMonthsContainer');
       if (archiveMonthsContainer) {
         archiveMonthsContainer.style.display = 'flex';
       }
       
       // Update data context and status message
       App.ui.updateDataContext();
       App.handlers.updateStatusWithPeriodInfo();
       
       // Update UI to show which archive month is active
       App.ui.updateArchiveMonthsUI(false, archiveMonth);
       
       // Mark current month as inactive
       App.data.currentMonthActive = false;
       
       // Hide loading indicator if it was shown
       App.ui.showLoadingIndicator(false);
     }, 500);
   })
   .catch(error => {
     App.handleError(`loading ${archiveMonth.month} ${archiveMonth.year} data`, error, 
                     `Failed to load ${archiveMonth.month} ${archiveMonth.year} award data. Please try again later.`);
     
     // Hide loading indicator if it was shown
     App.ui.showLoadingIndicator(false);
   });
};

/**
* Initialization functions
*/
App.init = function() {
 // Initialize DOM elements cache
 App.ui.cacheElements();
 
 // Clean the URL if it contains parameters, without reloading the page
 if (window.location.search) {
   const cleanUrl = window.location.protocol + "//" + 
                   window.location.host + 
                   window.location.pathname;
   window.history.replaceState({}, document.title, cleanUrl);
 }
 
 // Initialize the UI components
 App.utils.addEventListenerSafe(App.elements.loadBtn, 'click', App.handlers.loadCSVFile);
 App.utils.addEventListenerSafe(App.elements.resetFiltersBtn, 'click', App.handlers.resetAllFilters);
 
 // Set up unified search input
 if (App.elements.unifiedSearch) {
   App.utils.addEventListenerSafe(App.elements.unifiedSearch, 'input', function() {
     clearTimeout(App.elements.unifiedSearch.timer);
     App.elements.unifiedSearch.timer = setTimeout(function() {
       App.handlers.applyAllFilters();
     }, 300);
   });
   
   App.utils.addEventListenerSafe(App.elements.unifiedSearch, 'keypress', function(event) {
     if (event.key === 'Enter') {
       App.handlers.applyAllFilters();
     }
   });
 }
 /**
 * Show loading indicator
 */
App.ui.showLoadingIndicator = function(isLoading, message = "Loading data...", details = "", progress = -1) {
  // Create loading overlay if it doesn't exist
  let loadingOverlay = document.getElementById('loadingOverlay');
  
  if (!loadingOverlay && isLoading) {
    loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'loadingOverlay';
    loadingOverlay.innerHTML = `
      <div class="loading-spinner">
        <i class="fas fa-circle-notch fa-spin"></i>
        <div class="loading-message" id="loadingMessage">${message}</div>
        <div class="loading-details" id="loadingDetails">${details}</div>
        <div class="loading-progress">
          <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
      </div>
    `;
    document.body.appendChild(loadingOverlay);
  }
  
  // Show or hide the overlay
  if (loadingOverlay) {
    if (isLoading) {
      loadingOverlay.style.display = 'flex';
      
      // Update message and details if provided
      const msgEl = document.getElementById('loadingMessage');
      const detailsEl = document.getElementById('loadingDetails');
      const progressBar = document.getElementById('loadingProgressBar');
      
      if (msgEl) msgEl.textContent = message;
      
      if (detailsEl) {
        if (details) {
          detailsEl.textContent = details;
          detailsEl.style.display = 'block';
        } else {
          detailsEl.style.display = 'none';
        }
      }
      
      // Handle progress bar
      if (progressBar) {
        if (progress >= 0 && progress <= 100) {
          progressBar.style.width = `${progress}%`;
          progressBar.parentElement.style.display = 'block';
        } else {
          // Indeterminate progress or no progress specified
          progressBar.style.width = '100%';
          progressBar.style.animation = 'loading-progress 1.5s infinite ease-in-out';
          progressBar.parentElement.style.display = 'block';
        }
      }
    } else {
      // Add a fade-out effect before removing
      loadingOverlay.style.opacity = '0';
      setTimeout(() => {
        loadingOverlay.style.display = 'none';
        loadingOverlay.style.opacity = '1';
      }, 300);
    }
  }
};
 // Set up dashboard layout
 App.charts.setupDashboardGrid();
 
 // Theme initialization
 const themeToggle = document.getElementById('themeToggle');
 const currentTheme = localStorage.getItem('theme') || 'light'; // Default to light mode
 document.documentElement.setAttribute('data-theme', currentTheme);
 
 // Update icon to match current theme
 if (themeToggle) {
   const icon = themeToggle.querySelector('i');
   if (icon) {
     if (currentTheme === 'dark') {
       icon.classList.remove('fa-moon');
       icon.classList.add('fa-sun');
     } else {
       icon.classList.remove('fa-sun');
       icon.classList.add('fa-moon');
     }
   }
   
   // Set up theme toggle with chart color updates
   App.utils.addEventListenerSafe(themeToggle, 'click', App.ui.toggleTheme);
 }
 
 // Initialize charts
 App.charts.initCharts();
 
 // Initialize mobile features
 if (App.support.isMobile()) {
   App.ui.initMobileNavigation();
 }
 
 // Handle window resize events
 window.addEventListener('resize', function() {
   if (App.support.isMobile()) {
     App.ui.initMobileNavigation();
   } else {
     // Remove mobile header when switching to desktop
     const mobileHeader = document.getElementById('mobileHeader');
     if (mobileHeader) mobileHeader.remove();
   }
 });
 
 // Show initial message
 App.ui.showMessage("Select a CSV file to begin analysis.", "info");
 
 // Check if auto-load is enabled
 const autoLoadEnabled = true;
 
 if (autoLoadEnabled) {
   // Show loading message
   App.ui.showMessage("", "info", {
     "Status": "Loading current month award data..."
   });
   
   // Load current month data after a short delay to ensure charts are initialized
   setTimeout(function() {
     App.data.loadCurrentMonthData();
   }, 1000);
 }
};

// Initialize the application when the DOM is ready
document.addEventListener('DOMContentLoaded', App.init);

// Expose functions for external use
window.App = App;
</script>
</html>